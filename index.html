<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainify</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Coros Training Hub-ish: clean dark UI */
      --bg0:#0b0f14;
      --bg1:#0f151c;
      --card:#121a22;
      --card2:#0f171f;
      --stroke:#1e2a35;
      --stroke2:#223140;
      --text:#e9eef5;
      --muted:#9fb0c3;
      --muted2:#7f93aa;
      --accent:#2f6bff;    /* coros-like blue */
      --good:#22c55e;
      --bad:#ff4d6d;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --shadow2: 0 10px 30px rgba(0,0,0,0.35);
      --r16:16px;
      --r12:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(47,107,255,0.22), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,0.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 44px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:10px;
      background: linear-gradient(135deg, rgba(47,107,255,1), rgba(28,184,255,1));
      border:1px solid rgba(255,255,255,0.10);
      box-shadow:var(--shadow2);
    }
    .title h1{margin:0;font-size:18px;letter-spacing:-0.01em}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,0.18)}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--r16);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .cardHeader h2{
      margin:0;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.72);
    }
    .cardHeader p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4}
    .cardBody{padding:14px}

    .form{
      display:grid;gap:12px;
    }
    label{display:grid;gap:6px;color:rgba(255,255,255,0.78);font-size:12px}
    input, select, button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10,16,22,0.65);
      color:var(--text);
      outline:none;
      transition: 120ms ease;
      font-size:14px;
    }
    input::placeholder{color:rgba(255,255,255,0.38)}
    input:focus, select:focus{border-color: rgba(47,107,255,0.55); box-shadow: 0 0 0 4px rgba(47,107,255,0.20)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){.row2{grid-template-columns:1fr}}
    .timeRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted2);margin-top:2px}

    .btnPrimary{
      background: linear-gradient(135deg, rgba(47,107,255,1), rgba(28,184,255,1));
      border: 1px solid rgba(255,255,255,0.14);
      font-weight: 750;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(47,107,255,0.18);
    }
    .btnPrimary:hover{transform: translateY(-1px)}
    .btnPrimary:active{transform: translateY(0)}
    .msg{min-height:18px;margin-top:6px;font-size:13px;font-weight:650}

    .toolbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
    }
    .toolbarLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--muted);font-size:12px;
      white-space:nowrap;
    }
    .toolbarRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btnGhost{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      cursor:pointer;
      font-weight:700;
      color:rgba(255,255,255,0.86);
    }
    .btnGhost:hover{background: rgba(255,255,255,0.06); transform: translateY(-1px)}
    .btnGhost:active{transform: translateY(0)}
    .content{padding:14px}
    .sectionTitle{
      margin:0 0 10px;
      font-size:13px;
      color:rgba(255,255,255,0.86);
      letter-spacing:-0.01em;
    }

    .chartsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .chartsGrid{grid-template-columns:1fr} }

    .chartCard{
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--r16);
      padding:12px;
      overflow:hidden;
    }
    .chartHeader{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .chartHeader h3{margin:0;font-size:13px;color:rgba(255,255,255,0.88)}
    .chartHeader span{color:var(--muted);font-size:12px}
    canvas{width:100% !important; height:260px !important;}

    .list{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .item{
      padding:12px;
      border-radius:var(--r16);
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
    }
    .item strong{font-size:14px}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background: rgba(10,16,22,0.55);
      border:1px solid rgba(255,255,255,0.10);
      color:rgba(255,255,255,0.80);
      font-size:12px;
    }
    .notes{
      margin-top:8px;
      color:rgba(255,255,255,0.80);
      font-size:13px;
      line-height:1.45;
      padding:10px 12px;border-radius:12px;
      background: rgba(10,16,22,0.45);
      border:1px solid rgba(255,255,255,0.08);
    }
    .right{
      text-align:right;
      color:var(--muted2);
      font-family:var(--mono);
      font-size:12px;
      white-space:nowrap;
    }
    .empty{
      padding:14px;
      border-radius:var(--r16);
      border:1px dashed rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.02);
      color:var(--muted);
      line-height:1.5;
    }
    .footer{
      margin-top:14px;
      text-align:center;
      color:rgba(255,255,255,0.45);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Trainify</h1>
          <p>Logga tr√§ning manuellt nu. Import fr√•n COROS senare.</p>
        </div>
      </div>
      <div class="pill"><span class="dot"></span>Live mot Supabase</div>
    </div>

    <div class="grid">
      <!-- LEFT: Add activity -->
      <section class="card">
        <div class="cardHeader">
          <h2>Nytt pass</h2>
          <p>Sportval: <strong>L√∂pning</strong> eller <strong>Styrketr√§ning</strong>. Tid anges i timmar & minuter.</p>
        </div>
        <div class="cardBody">
          <form id="activity-form" class="form" autocomplete="off">
            <label>
              Datum & tid
              <input type="datetime-local" id="start_time" required />
            </label>

            <label>
              Sport
              <select id="sport" required>
                <option value="L√∂pning">L√∂pning</option>
                <option value="Styrketr√§ning">Styrketr√§ning</option>
              </select>
            </label>

            <label>
              Namn (valfritt)
              <input type="text" id="name" placeholder="t.ex. Intervaller, Helkropp" />
            </label>

            <div class="row2">
              <div>
                <div class="timeRow">
                  <label>
                    Tid ‚Äî timmar
                    <input type="number" id="duration_h" min="0" placeholder="0" />
                  </label>
                  <label>
                    Tid ‚Äî minuter
                    <input type="number" id="duration_min" min="0" max="59" placeholder="45" />
                  </label>
                </div>
                <div class="hint">Tempo (min/km) r√§knas automatiskt i listan om distans + tid finns.</div>
              </div>

              <label>
                Distans (km) (valfritt)
                <input type="number" id="distance_km" min="0" step="0.01" placeholder="t.ex. 10.00" />
              </label>
            </div>

            <label>
              Anteckningar (valfritt)
              <input type="text" id="notes" placeholder="k√§nsla, uppl√§gg, vikter..." />
            </label>

            <button class="btnPrimary" type="submit">Spara pass</button>
            <div id="msg" class="msg" aria-live="polite"></div>
          </form>
        </div>
      </section>

      <!-- RIGHT: Dashboard -->
      <section class="card">
        <div class="toolbar">
          <div class="toolbarLeft">
            <div class="chip" id="countChip">0 pass</div>
            <div class="chip" id="lastChip">Senast: ‚Äî</div>
          </div>
          <div class="toolbarRight">
            <select id="yearSelect" style="width:auto; min-width: 140px;">
              <option value="">√Ör‚Ä¶</option>
            </select>
            <button class="btnGhost" id="reloadBtn" type="button">Uppdatera</button>
          </div>
        </div>

        <div class="content">
          <h3 class="sectionTitle">√Örs√∂versikt</h3>

          <div class="chartsGrid">
            <div class="chartCard">
              <div class="chartHeader">
                <h3>L√∂pning</h3>
                <span>Antal pass + tid per m√•nad</span>
              </div>
              <canvas id="chartRun"></canvas>
            </div>

            <div class="chartCard">
              <div class="chartHeader">
                <h3>Styrketr√§ning</h3>
                <span>Antal pass + tid per m√•nad</span>
              </div>
              <canvas id="chartStrength"></canvas>
            </div>
          </div>

          <h3 class="sectionTitle" style="margin-top:14px;">Senaste pass</h3>
          <div id="activities" class="empty">Laddar‚Ä¶</div>
        </div>
      </section>
    </div>

    <div class="footer">
      Tips: St√§ng av RLS i Supabase medan du prototypar, annars blockas l√§s/skriv fr√•n denna statiska sida.
    </div>
  </div>

  <script>
    // Supabase (dina v√§rden)
    const SUPABASE_URL = "https://pmstnkmloyipsrveqidg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Mb-z3MZvMP_KC09dMXE-AQ_AauF362I";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const form = document.getElementById("activity-form");
    const msg = document.getElementById("msg");
    const activitiesDiv = document.getElementById("activities");
    const reloadBtn = document.getElementById("reloadBtn");
    const yearSelect = document.getElementById("yearSelect");
    const countChip = document.getElementById("countChip");
    const lastChip = document.getElementById("lastChip");

    // Charts
    const monthLabels = ["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];
    let chartRun = null;
    let chartStrength = null;

    function setMessage(text, isError=false){
      msg.textContent = text || "";
      msg.style.color = isError ? "var(--bad)" : "var(--good)";
    }

    function safeText(v){
      const span = document.createElement("span");
      span.textContent = (v ?? "").toString();
      return span.innerHTML;
    }

    function formatDistance(meters){
      if (!meters || meters <= 0) return null;
      const km = meters / 1000;
      return `${km.toFixed(km < 10 ? 2 : 1)} km`;
    }

    function formatDuration(seconds){
      if (!seconds || seconds <= 0) return null;
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function calcPace(duration_s, distance_m){
      if (!duration_s || !distance_m || distance_m <= 0) return null;
      const secPerKm = duration_s / (distance_m / 1000);
      if (!isFinite(secPerKm)) return null;
      const mm = Math.floor(secPerKm / 60);
      const ss = Math.round(secPerKm % 60).toString().padStart(2,"0");
      return `${mm}:${ss} min/km`;
    }

    function toHours(seconds){
      if (!seconds || seconds <= 0) return 0;
      return seconds / 3600;
    }

    function setSummary(list){
      countChip.textContent = `${list.length} pass`;
      if (list.length){
        const latest = new Date(list[0].start_time);
        lastChip.textContent = `Senast: ${latest.toLocaleDateString()} ${latest.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
      } else {
        lastChip.textContent = "Senast: ‚Äî";
      }
    }

    function yearsFromActivities(list){
      const ys = new Set();
      for (const a of list){
        const d = new Date(a.start_time);
        if (!isNaN(d.getTime())) ys.add(d.getFullYear());
      }
      return Array.from(ys).sort((a,b)=>b-a);
    }

    function ensureYearOptions(allActivities){
      const ys = yearsFromActivities(allActivities);
      const current = new Date().getFullYear();
      if (!ys.includes(current)) ys.unshift(current);

      const selected = yearSelect.value;
      yearSelect.innerHTML = "";
      for (const y of ys){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        yearSelect.appendChild(opt);
      }
      // restore selection if possible
      if (selected && ys.includes(Number(selected))){
        yearSelect.value = selected;
      } else {
        yearSelect.value = String(current);
      }
    }

    function buildYearBuckets(list, year){
      // returns { sportName: {counts:[12], hours:[12]} }
      const init = () => ({ counts: Array(12).fill(0), hours: Array(12).fill(0) });
      const out = {
        "L√∂pning": init(),
        "Styrketr√§ning": init()
      };

      for (const a of list){
        const d = new Date(a.start_time);
        if (isNaN(d.getTime())) continue;
        if (d.getFullYear() !== year) continue;

        const month = d.getMonth(); // 0-11
        const sport = a.sport || "Ok√§nt";
        if (!out[sport]) continue;

        out[sport].counts[month] += 1;
        out[sport].hours[month] += toHours(a.duration_s);
      }
      return out;
    }

    function makeDualBarChart(canvasId, title, counts, hours){
      const ctx = document.getElementById(canvasId);

      // Destroy existing
      if (canvasId === "chartRun" && chartRun) chartRun.destroy();
      if (canvasId === "chartStrength" && chartStrength) chartStrength.destroy();

      const chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: "Antal pass",
              data: counts,
              yAxisID: "yCount",
              borderWidth: 0,
              borderRadius: 8,
              // let Chart.js choose defaults; we set minimal styling via theme below
            },
            {
              label: "Tid (h)",
              data: hours.map(v => Math.round(v * 10) / 10),
              yAxisID: "yHours",
              borderWidth: 0,
              borderRadius: 8,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: { color: "rgba(233,238,245,0.85)", boxWidth: 10, boxHeight: 10 }
            },
            tooltip: {
              callbacks: {
                label: function(ctx){
                  const v = ctx.raw;
                  if (ctx.dataset.label === "Tid (h)") return ` ${ctx.dataset.label}: ${v} h`;
                  return ` ${ctx.dataset.label}: ${v}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: "rgba(255,255,255,0.06)" },
              ticks: { color: "rgba(159,176,195,0.95)" }
            },
            yCount: {
              position: "left",
              beginAtZero: true,
              grid: { color: "rgba(255,255,255,0.06)" },
              ticks: { color: "rgba(159,176,195,0.95)", precision: 0 },
              title: { display: true, text: "Antal", color: "rgba(159,176,195,0.95)" }
            },
            yHours: {
              position: "right",
              beginAtZero: true,
              grid: { drawOnChartArea: false },
              ticks: { color: "rgba(159,176,195,0.95)" },
              title: { display: true, text: "Timmar", color: "rgba(159,176,195,0.95)" }
            }
          }
        }
      });

      if (canvasId === "chartRun") chartRun = chart;
      if (canvasId === "chartStrength") chartStrength = chart;
    }

    async function fetchAllActivities(){
      // Pull enough rows for year stats. Increase limit if needed later.
      const { data, error } = await sb
        .from("activities")
        .select("id,start_time,sport,name,duration_s,distance_m,notes,source")
        .order("start_time", { ascending: false })
        .limit(5000);

      if (error) throw error;
      return data || [];
    }

    function renderLatestList(list){
      const latest = list.slice(0, 40);

      if (!latest.length){
        activitiesDiv.className = "empty";
        activitiesDiv.innerHTML = "<strong>Inga pass √§nnu.</strong><br/>L√§gg till ditt f√∂rsta pass till v√§nster.";
        return;
      }

      activitiesDiv.className = "list";
      activitiesDiv.innerHTML = "";

      for (const a of latest){
        const div = document.createElement("div");
        div.className = "item";

        const when = new Date(a.start_time);
        const whenText = `${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;

        const dist = formatDistance(a.distance_m);
        const dur = formatDuration(a.duration_s);
        const pace = calcPace(a.duration_s, a.distance_m);

        const name = a.name ? safeText(a.name) : "";
        const notes = a.notes ? safeText(a.notes) : "";

        div.innerHTML = `
          <div>
            <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap;">
              <strong>${whenText}</strong>
              <span class="tag">${safeText(a.sport || "Ok√§nt")}</span>
              ${name ? `<span class="tag" style="opacity:.92">${name}</span>` : ``}
            </div>

            <div class="meta">
              ${dist ? `<span class="tag">üìè ${dist}</span>` : ``}
              ${dur ? `<span class="tag">‚è±Ô∏è ${dur}</span>` : ``}
              ${pace ? `<span class="tag">‚ö° ${pace}</span>` : ``}
              <span class="tag">üóÇÔ∏è ${safeText(a.source || "manual")}</span>
            </div>

            ${notes ? `<div class="notes">${notes}</div>` : ``}
          </div>

          <div class="right">${safeText(a.id)}</div>
        `;

        activitiesDiv.appendChild(div);
      }
    }

    async function refresh(){
      activitiesDiv.className = "empty";
      activitiesDiv.textContent = "Laddar‚Ä¶";
      setMessage("");

      try {
        const all = await fetchAllActivities();
        ensureYearOptions(all);

        // summary chips should reflect latest overall
        setSummary(all);

        const year = Number(yearSelect.value) || new Date().getFullYear();
        const buckets = buildYearBuckets(all, year);

        makeDualBarChart("chartRun", "L√∂pning", buckets["L√∂pning"].counts, buckets["L√∂pning"].hours);
        makeDualBarChart("chartStrength", "Styrketr√§ning", buckets["Styrketr√§ning"].counts, buckets["Styrketr√§ning"].hours);

        renderLatestList(all);

      } catch (e) {
        activitiesDiv.className = "empty";
        activitiesDiv.textContent = "Kunde inte ladda data.";
        setMessage(e?.message || "Ok√§nt fel", true);
      }
    }

    reloadBtn.addEventListener("click", refresh);
    yearSelect.addEventListener("change", refresh);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage("");

      const start_time = document.getElementById("start_time").value;
      const sport = document.getElementById("sport").value; // already controlled
      const name = document.getElementById("name").value.trim() || null;
      const notes = document.getElementById("notes").value.trim() || null;

      const duration_h_raw = document.getElementById("duration_h").value;
      const duration_min_raw = document.getElementById("duration_min").value;
      const distance_km_raw = document.getElementById("distance_km").value;

      const h = duration_h_raw ? Math.max(0, Number(duration_h_raw)) : 0;
      const m = duration_min_raw ? Math.max(0, Number(duration_min_raw)) : 0;

      if (duration_min_raw && Number(duration_min_raw) > 59) {
        setMessage("Minuter m√•ste vara 0‚Äì59.", true);
        return;
      }

      const duration_s = (h || m) ? (Math.floor(h) * 3600 + Math.floor(m) * 60) : null;
      const distance_m = distance_km_raw ? Number(distance_km_raw) * 1000 : null;

      try {
        const { error } = await sb.from("activities").insert({
          source: "manual",
          start_time: new Date(start_time).toISOString(),
          sport,
          name,
          duration_s,
          distance_m,
          notes
        });

        if (error) throw error;

        form.reset();
        setMessage("Sparat!");
        refresh();

      } catch (e2) {
        setMessage(e2?.message || "Kunde inte spara", true);
      }
    });

    // initial
    refresh();
  </script>
</body>
</html>
