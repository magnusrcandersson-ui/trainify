<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainify</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f4f6f9;
    }

    h1 {
      margin-bottom: 20px;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      display: grid;
      gap: 12px;
      margin-bottom: 30px;
    }

    input, button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      background: #111;
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover {
      opacity: 0.9;
    }

    .activity {
      background: white;
      padding: 16px;
      border-radius: 14px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .small {
      opacity: 0.7;
      font-size: 0.9em;
    }

    #msg {
      font-weight: 600;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <h1>Trainify ðŸ’ª</h1>

  <form id="activity-form">
    <label>
      Datum & tid
      <input type="datetime-local" id="start_time" required />
    </label>

    <label>
      Sport
      <input type="text" id="sport" placeholder="Run, Bike..." required />
    </label>

    <label>
      Namn (valfritt)
      <input type="text" id="name" />
    </label>

    <label>
      Tid (sekunder)
      <input type="number" id="duration_s" min="0" />
    </label>

    <label>
      Distans (km)
      <input type="number" id="distance_km" min="0" step="0.01" />
    </label>

    <label>
      Anteckningar
      <input type="text" id="notes" />
    </label>

    <button type="submit">Spara pass</button>
    <div id="msg"></div>
  </form>

  <h2>Senaste pass</h2>
  <button onclick="loadActivities()">Uppdatera</button>
  <div id="activities"></div>

  <script>
    // Dina riktiga Supabase-nycklar
    const SUPABASE_URL = "https://pmstnkmloyipsrveqidg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Mb-z3MZvMP_KC09dMXE-AQ_AauF362I";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("activity-form");
    const activitiesDiv = document.getElementById("activities");
    const msg = document.getElementById("msg");

    function setMessage(text, isError = false) {
      msg.textContent = text;
      msg.style.color = isError ? "crimson" : "green";
    }

    window.loadActivities = async function loadActivities() {
      activitiesDiv.innerHTML = "Laddar...";

      const { data, error } = await sb
        .from("activities")
        .select("*")
        .order("start_time", { ascending: false })
        .limit(100);

      if (error) {
        activitiesDiv.innerHTML = "";
        setMessage(error.message, true);
        return;
      }

      activitiesDiv.innerHTML = "";

      data.forEach((a) => {
        const div = document.createElement("div");
        div.className = "activity";

        const km = a.distance_m ? (a.distance_m / 1000).toFixed(2) : null;

        div.innerHTML = `
          <div><strong>${new Date(a.start_time).toLocaleString()}</strong> â€” ${a.sport}</div>
          <div class="small">
            ${a.name ? a.name + " â€” " : ""}
            ${km ? km + " km â€” " : ""}
            ${a.duration_s ? a.duration_s + " s" : ""}
          </div>
          ${a.notes ? `<div class="small">${a.notes}</div>` : ""}
        `;

        activitiesDiv.appendChild(div);
      });
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMessage("");

      const start_time = document.getElementById("start_time").value;
      const sport = document.getElementById("sport").value.trim();
      const name = document.getElementById("name").value.trim() || null;
      const duration_s_raw = document.getElementById("duration_s").value;
      const distance_km_raw = document.getElementById("distance_km").value;
      const notes = document.getElementById("notes").value.trim() || null;

      const duration_s = duration_s_raw ? Number(duration_s_raw) : null;
      const distance_m = distance_km_raw ? Number(distance_km_raw) * 1000 : null;

      const { error } = await sb.from("activities").insert({
        source: "manual",
        start_time: new Date(start_time).toISOString(),
        sport,
        name,
        duration_s,
        distance_m,
        notes
      });

      if (error) {
        setMessage(error.message, true);
        return;
      }

      form.reset();
      setMessage("Sparat!");
      window.loadActivities();
    });

    // Ladda vid start
    window.loadActivities();
  </script>

</body>
</html>
