<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainify</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:       #181b2e;
      --bg1:      #1f2340;
      --bg2:      #252847;
      --bg3:      #2c3054;
      --bg4:      #333860;
      --border:   rgba(150,160,255,0.22);
      --border2:  rgba(150,160,255,0.38);
      --text:     #e8eaf8;
      --muted:    #a0a8d8;
      --muted2:   #7a85b8;
      --accent:   #6366f1;
      --accent2:  #818cf8;
      --violet:   #a78bfa;
      --violet2:  #c4b5fd;
      --blue:     #3b82f6;
      --blue2:    #60a5fa;
      --cyan:     #22d3ee;
      --good:     #34d399;
      --bad:      #f87171;
      --glow:     rgba(99,102,241,0.25);
      --glow2:    rgba(167,139,250,0.2);
      --mono: 'SF Mono', ui-monospace, Menlo, Monaco, monospace;
      --sans: 'Inter', system-ui, sans-serif;
      --display: 'Space Grotesk', 'Inter', system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      background-image:
        radial-gradient(ellipse 900px 700px at 15% -5%,  rgba(99,102,241,0.22) 0%, transparent 55%),
        radial-gradient(ellipse 700px 600px at 85%  5%,  rgba(167,139,250,0.16) 0%, transparent 50%),
        radial-gradient(ellipse 600px 500px at 50% 100%, rgba(59,130,246,0.13) 0%, transparent 55%);
      min-height: 100vh;
    }

    /* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
    .topbar {
      position: sticky; top: 0; z-index: 200;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      height: 88px; padding: 0 36px;
      background: rgba(24,27,46,0.93);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(28px) saturate(1.8);
      -webkit-backdrop-filter: blur(28px) saturate(1.8);
    }
    .brand {
      display: flex; align-items: center; gap: 14px;
      justify-self: start;
    }
    .logo-mark {
      position: relative;
      width: 64px; height: 64px; border-radius: 18px; flex-shrink: 0;
      background: linear-gradient(145deg, #8b80f9 0%, #5b5ce8 40%, #a78bfa 100%);
      display: flex; align-items: center; justify-content: center;
      box-shadow:
        0 0 0 1px rgba(167,139,250,0.35),
        0 4px 22px rgba(99,102,241,0.6),
        0 12px 44px rgba(99,102,241,0.3),
        inset 0 1px 0 rgba(255,255,255,0.2);
      transition: transform 220ms ease, box-shadow 220ms ease;
      cursor: default;
    }
    .logo-mark:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow:
        0 0 0 1px rgba(167,139,250,0.5),
        0 8px 32px rgba(99,102,241,0.75),
        0 18px 56px rgba(99,102,241,0.38),
        inset 0 1px 0 rgba(255,255,255,0.24);
    }
    .logo-mark::before {
      content: ''; position: absolute; inset: 0; border-radius: 16px;
      background: linear-gradient(145deg, rgba(255,255,255,0.18) 0%, transparent 55%);
      pointer-events: none;
    }
    .logo-mark svg { width: 33px; height: 33px; position: relative; z-index: 1; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.55)); }
    .brand-text { display: flex; flex-direction: column; gap: 2px; }
    .brand-name {
      font-family: var(--display); font-size: 28px; font-weight: 700;
      letter-spacing: -0.03em; line-height: 1.05;
      background: linear-gradient(130deg, #f0f2ff 15%, #c4b5fd 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .brand-sub {
      font-size: 10.5px; color: var(--muted2); font-weight: 700;
      letter-spacing: 0.14em; text-transform: uppercase;
    }
    .nav-center { justify-self: center; }
    .topbar-right { display: flex; align-items: center; gap: 8px; justify-self: end; }

    .nav-tabs {
      display: flex; align-items: center; gap: 2px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 4px;
    }
    .nav-tab {
      appearance: none; border: none; background: transparent;
      color: var(--muted); font-family: var(--sans); font-size: 13px; font-weight: 600;
      padding: 7px 20px; border-radius: 9px; cursor: pointer; transition: all 150ms ease;
    }
    .nav-tab:hover:not(.active) { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-tab.active { background: linear-gradient(135deg, var(--accent), var(--violet)); color: #fff; box-shadow: 0 4px 18px var(--glow); }

    .status-pills { display: flex; align-items: center; gap: 8px; }
    .status-pill {
      display: flex; align-items: center; gap: 7px; padding: 6px 13px; border-radius: 999px;
      font-size: 12px; font-weight: 500; background: rgba(255,255,255,0.04);
      border: 1px solid var(--border); color: var(--muted); white-space: nowrap;
    }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%; background: var(--good);
      box-shadow: 0 0 0 3px rgba(52,211,153,0.2), 0 0 8px rgba(52,211,153,0.4);
      animation: pulse 2.4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 3px rgba(52,211,153,0.2), 0 0 8px rgba(52,211,153,0.3); }
      50%      { box-shadow: 0 0 0 5px rgba(52,211,153,0.1), 0 0 16px rgba(52,211,153,0.5); }
    }

    /* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
    .page-wrap {
      max-width: 1400px; margin: 0 auto;
      padding: 28px 24px 80px;
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto;
      gap: 20px;
      align-items: start;
    }
    .top-form-row { grid-column: 1; grid-row: 1; }
    .top-form-row.hidden { display: none; }
    .top-form-row > .panel { width: 100%; }
    .main-content { grid-column: 2; grid-row: 1; }
    /* When form hidden (logg tab), content spans full width */
    .top-form-row.hidden ~ .main-content { grid-column: 1 / -1; }
    @media (max-width: 900px) {
      .page-wrap { grid-template-columns: 1fr; }
      .top-form-row, .main-content { grid-column: 1; }
      .top-form-row.hidden ~ .main-content { grid-column: 1; }
    }

    /* ‚ïê‚ïê PANEL ‚ïê‚ïê */
    .panel {
      background: var(--bg1); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; position: relative;
    }
    .panel::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(99,102,241,0.5), rgba(167,139,250,0.4), transparent);
      pointer-events: none;
    }
    .panel-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); }
    .panel-title   { font-family: var(--display); font-size: 15px; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }
    .panel-subtitle{ font-size: 13px; color: var(--muted); margin-top: 4px; line-height: 1.5; }
    .panel-body    { padding: 24px; }
    .top-form-row .panel-body { padding: 18px 20px; }
    .top-form-row .panel-header { padding: 16px 20px 13px; }
    .top-form-row .panel-title { font-size: 13px; }
    .top-form-row .panel-subtitle { font-size: 12px; margin-top: 3px; }
    .top-form-row .form { gap: 12px; }
    .top-form-row input,
    .top-form-row select { padding: 9px 12px; font-size: 13px; }
    .top-form-row .btn-primary { padding: 11px 16px; font-size: 13px; }
    .top-form-row .field-label { font-size: 10.5px; }
    .top-form-row .row3 { gap: 8px; }
    .top-form-row .panel-footer { padding: 10px 20px; font-size: 11px; }
    .panel-footer  { padding: 13px 24px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted2); text-align: center; background: rgba(255,255,255,0.01); }

    /* ‚ïê‚ïê FORM ‚ïê‚ïê */
    .form { display: grid; gap: 16px; }
    .field { display: grid; gap: 7px; }
    .field-label { font-size: 11px; font-weight: 700; letter-spacing: 0.09em; text-transform: uppercase; color: var(--muted); }

    input, select {
      width: 100%; padding: 11px 14px; border-radius: 10px;
      border: 1px solid rgba(120,130,220,0.15); background: rgba(28,32,58,0.78);
      color: var(--text); outline: none; font-family: var(--sans); font-size: 14px; font-weight: 500;
      transition: border-color 150ms, box-shadow 150ms; -webkit-appearance: none; appearance: none;
    }
    input::placeholder { color: rgba(255,255,255,0.2); }
    input:focus, select:focus {
      border-color: rgba(99,102,241,0.6);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15), 0 0 16px rgba(99,102,241,0.08);
    }
    select option { background: var(--bg2); }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 520px) { .row2, .row3 { grid-template-columns: 1fr; } }
    .hint-text { font-size: 12px; color: var(--muted2); margin-top: 3px; }

    .btn-primary {
      cursor: pointer; width: 100%; padding: 13px 20px; border: none; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--violet) 100%);
      color: #fff; font-family: var(--sans); font-size: 14px; font-weight: 700;
      box-shadow: 0 8px 28px var(--glow); transition: transform 130ms ease, box-shadow 130ms ease, opacity 130ms;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 36px var(--glow2); }
    .btn-primary:active { transform: translateY(0); opacity: 0.9; }

    .btn-ghost {
      cursor: pointer; padding: 9px 16px; border-radius: 10px; border: 1px solid var(--border2);
      background: rgba(255,255,255,0.04); color: var(--text); font-family: var(--sans);
      font-size: 12px; font-weight: 600; width: auto; white-space: nowrap;
      transition: background 130ms, border-color 130ms, transform 130ms;
    }
    .btn-ghost:hover { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.35); transform: translateY(-1px); }
    .btn-ghost:active { transform: translateY(0); }

    .msg { min-height: 18px; font-size: 13px; font-weight: 600; text-align: center; margin-top: 4px; }

    /* ‚ïê‚ïê CALENDAR PICKER ‚ïê‚ïê */
    .date-picker-wrap { position: relative; }
    .date-display {
      width: 100%; padding: 11px 14px; border-radius: 10px;
      border: 1px solid rgba(120,130,220,0.15); background: rgba(28,32,58,0.78);
      color: var(--text); font-family: var(--sans); font-size: 14px; font-weight: 500;
      cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 10px;
      transition: border-color 150ms, box-shadow 150ms; user-select: none;
    }
    .date-display:hover, .date-display.open {
      border-color: rgba(99,102,241,0.6); box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }
    .date-display .placeholder { color: rgba(255,255,255,0.22); }
    .date-display .cal-icon { opacity: 0.55; font-size: 15px; flex-shrink: 0; }

    .calendar-popup {
      display: none; position: absolute; top: calc(100% + 8px); left: 0; z-index: 500;
      width: 320px; background: #272b4a; border: 1px solid var(--border2); border-radius: 16px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.7), 0 0 0 1px rgba(99,102,241,0.1); overflow: hidden;
      animation: dropIn 160ms ease both;
    }
    .calendar-popup.open { display: block; }
    @keyframes dropIn { from { opacity:0; transform:translateY(-8px) scale(0.97); } to { opacity:1; transform:translateY(0) scale(1); } }

    .cal-top {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px 10px; border-bottom: 1px solid var(--border); gap: 8px;
    }
    .cal-nav-btn {
      appearance: none; border: none; background: transparent; color: var(--muted);
      cursor: pointer; width: 28px; height: 28px; border-radius: 7px;
      display: flex; align-items: center; justify-content: center; font-size: 15px;
      transition: background 130ms, color 130ms; flex-shrink: 0;
    }
    .cal-nav-btn:hover { background: rgba(99,102,241,0.15); color: var(--accent2); }
    .cal-month-label { font-family: var(--display); font-size: 14px; font-weight: 700; color: var(--text); flex: 1; text-align: center; letter-spacing: -0.01em; }

    .cal-grid { padding: 10px 14px; }
    .cal-weekdays { display: grid; grid-template-columns: repeat(7,1fr); margin-bottom: 6px; }
    .cal-wd { text-align: center; font-size: 10.5px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted2); padding: 4px 0; }
    .cal-days { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }
    .cal-day {
      aspect-ratio: 1; border-radius: 8px; border: none; background: transparent;
      color: var(--muted); font-size: 13px; font-weight: 500;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background 120ms, color 120ms;
    }
    .cal-day:hover:not(.empty):not(.selected) { background: rgba(99,102,241,0.15); color: var(--accent2); }
    .cal-day.other-month { color: var(--muted2); opacity: 0.35; }
    .cal-day.today { color: var(--accent2); font-weight: 700; position: relative; }
    .cal-day.today::after {
      content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
      width: 4px; height: 4px; border-radius: 50%; background: var(--accent2);
    }
    .cal-day.selected {
      background: linear-gradient(135deg, var(--accent), var(--violet));
      color: #fff !important; font-weight: 700;
      box-shadow: 0 4px 14px var(--glow);
    }
    .cal-day.empty { pointer-events: none; }

    .cal-time {
      padding: 12px 16px 14px; border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;
    }
    .cal-time-label { font-size: 10px; font-weight: 700; letter-spacing: 0.09em; text-transform: uppercase; color: var(--muted2); margin-bottom: 6px; }
    .cal-time-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .cal-time input { padding: 8px 10px; font-size: 13px; text-align: center; }
    .cal-confirm {
      appearance: none; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--violet));
      color: #fff; font-family: var(--sans); font-size: 12px; font-weight: 700;
      padding: 10px 14px; border-radius: 8px; white-space: nowrap;
      box-shadow: 0 4px 14px var(--glow); transition: opacity 130ms; align-self: end;
    }
    .cal-confirm:hover { opacity: 0.88; }

    /* ‚ïê‚ïê TOOLBAR ‚ïê‚ïê */
    .toolbar {
      display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;
      padding: 16px 24px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.012);
    }
    .toolbar-left  { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .toolbar-right { display: flex; gap: 8px; align-items: center; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 13px; background: var(--bg2); border: 1px solid var(--border); border-radius: 999px; font-size: 12px; font-weight: 600; color: var(--muted); white-space: nowrap; }
    .chip-accent { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.3); color: var(--accent2); }

    /* ‚ïê‚ïê STATS ‚ïê‚ïê */
    .stats-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 18px; }
    @media (max-width: 680px) { .stats-row { grid-template-columns: 1fr; } }
    .stat-card {
      background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
      padding: 18px 20px; position: relative; overflow: hidden;
    }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent), var(--violet)); }
    .stat-card::after  { content: ''; position: absolute; top: -40px; right: -40px; width: 120px; height: 120px; border-radius: 50%; background: radial-gradient(circle, rgba(99,102,241,0.15) 0%, transparent 70%); pointer-events: none; }
    .stat-card.blue::before   { background: linear-gradient(90deg, var(--blue), var(--cyan)); }
    .stat-card.blue::after    { background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, transparent 70%); }
    .stat-card.violet::before { background: linear-gradient(90deg, var(--violet), var(--violet2)); }
    .stat-card.violet::after  { background: radial-gradient(circle, rgba(167,139,250,0.15) 0%, transparent 70%); }
    .stat-label { font-size: 10.5px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); position: relative; z-index: 1; }
    .stat-value { margin-top: 10px; font-family: var(--display); font-size: 38px; font-weight: 700; letter-spacing: -0.03em; line-height: 1; color: var(--text); position: relative; z-index: 1; }
    .stat-unit  { font-size: 18px; font-weight: 500; color: var(--muted); margin-left: 2px; }
    .stat-sub   { margin-top: 6px; font-size: 12px; color: var(--muted2); font-weight: 500; position: relative; z-index: 1; }

    /* ‚ïê‚ïê CHARTS ‚ïê‚ïê */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 680px) { .charts-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; padding: 18px 20px; }
    .chart-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .chart-card-title { font-family: var(--display); font-size: 14px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .sport-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.04em; }
    .sport-badge.run      { background: rgba(99,102,241,0.15); color: var(--accent2); border: 1px solid rgba(99,102,241,0.25); }
    .sport-badge.strength { background: rgba(167,139,250,0.15); color: var(--violet2); border: 1px solid rgba(167,139,250,0.25); }
    .chart-card-meta { font-size: 11.5px; color: var(--muted2); font-weight: 500; }
    .chart-wrap { position: relative; height: 230px; }
    canvas { width: 100% !important; height: 100% !important; display: block; }

    /* ‚ïê‚ïê SECTION HDR ‚ïê‚ïê */
    .section-hdr { display: flex; align-items: center; justify-content: space-between; padding: 18px 24px 12px; }
    .section-hdr-title { font-family: var(--display); font-size: 14px; font-weight: 700; color: var(--text); }
    .section-hdr-sub   { font-size: 12px; color: var(--muted2); font-weight: 500; }

    /* ‚ïê‚ïê ACTIVITY LIST ‚ïê‚ïê */
    .activities-list { display: grid; gap: 8px; padding: 0 20px 20px; }
    .activity-item {
      display: grid; grid-template-columns: auto 1fr auto; align-items: start; gap: 14px;
      padding: 14px 16px; background: var(--bg2); border: 1px solid var(--border); border-radius: 14px;
      transition: border-color 140ms, background 140ms, transform 120ms;
    }
    .activity-item:hover { background: var(--bg3); border-color: rgba(99,102,241,0.25); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .activity-icon { width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .activity-icon.run      { background: rgba(99,102,241,0.15); }
    .activity-icon.strength { background: rgba(167,139,250,0.14); }
    .activity-body  { min-width: 0; }
    .activity-name  { font-size: 14px; font-weight: 700; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .activity-when  { font-size: 12px; color: var(--muted); margin-top: 3px; }
    .activity-tags  { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 9px; }
    .tag { display: inline-flex; align-items: center; gap: 5px; padding: 4px 9px; border-radius: 6px; background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.15); color: var(--muted); font-size: 11.5px; font-weight: 600; }
    .activity-notes { margin-top: 8px; padding: 8px 12px; background: rgba(28,32,58,0.65); border-left: 2px solid rgba(99,102,241,0.5); border-radius: 0 8px 8px 0; font-size: 12.5px; color: var(--muted); line-height: 1.5; }
    .activity-id { font-family: var(--mono); font-size: 10px; color: var(--muted2); white-space: nowrap; padding-top: 3px; }

    .empty-state { padding: 48px 20px; text-align: center; color: var(--muted); border: 1px dashed rgba(99,102,241,0.2); border-radius: 14px; margin: 12px 20px; }
    .empty-state-icon  { font-size: 34px; margin-bottom: 12px; }
    .empty-state-title { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .empty-state-sub   { font-size: 13px; }

    .view { display: none; }
    .view.active { display: block; }
    .year-select-wrap select { width: auto; min-width: 110px; padding: 8px 12px; font-size: 13px; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.4); }

    @keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }
    .panel { animation: fadeUp 320ms ease both; }
    .panel:nth-child(2) { animation-delay: 60ms; }
    .stat-card { animation: fadeUp 320ms ease both; }
    .stat-card:nth-child(2) { animation-delay: 55ms; }
    .stat-card:nth-child(3) { animation-delay: 110ms; }

    /* ‚ïê‚ïê PR & RACES ‚ïê‚ïê */

    .mini-item.best { border-color: rgba(52,211,153,0.35); box-shadow: 0 10px 30px rgba(52,211,153,0.10); }
    .mini-item.best .mini-time { background: linear-gradient(135deg, rgba(52,211,153,0.95), rgba(34,211,238,0.95));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .badge-best { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 800; letter-spacing: 0.04em;
      background: rgba(52,211,153,0.12); border: 1px solid rgba(52,211,153,0.22); color: rgba(167,255,220,0.95); }
    .lock-row { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .lock-pill { cursor:pointer; user-select:none; }
    .locked .mini-actions button { opacity: 0.35; pointer-events:none; }
    .locked .mini-form button { opacity: 0.55; }
    .pr-trend { margin-top: 6px; background: rgba(255,255,255,0.02); border: 1px solid rgba(150,160,255,0.14);
      border-radius: 14px; padding: 12px 12px; }
    .pr-trend-top { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom: 10px; }
    .pr-trend-title { font-size: 12px; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
    .pr-trend select { width:auto; min-width: 140px; padding: 8px 10px; font-size: 13px; }
    .pr-trend-canvas { position: relative; height: 160px; }

    .records-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
    @media (max-width: 920px) { .records-grid { grid-template-columns: 1fr; } }
    .records-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    .records-card-hdr { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding: 16px 18px; border-bottom:1px solid rgba(150,160,255,0.14); }
    .records-card-title { font-family: var(--display); font-size: 14px; font-weight: 700; color: var(--text); }
    .records-card-sub { font-size: 12px; color: var(--muted2); margin-top: 4px; }
    .records-body { padding: 16px 18px; display: grid; gap: 12px; }
    .mini-form { display:grid; gap:10px; }
    .mini-form .row2, .mini-form .row3 { gap: 10px; }
    .mini-form input, .mini-form select { padding: 9px 12px; font-size: 13px; }
    .mini-form .btn-primary { padding: 11px 14px; font-size: 13px; box-shadow:none; }
    .list-mini { display:grid; gap:8px; margin-top: 6px; }
    .mini-item { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:start;
      padding: 12px 12px; background: rgba(28,32,58,0.55); border: 1px solid rgba(150,160,255,0.14); border-radius: 14px; }
    .mini-main { min-width:0; }
    .mini-top { display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .mini-name { font-size: 13.5px; font-weight: 800; color: var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .mini-time { font-family: var(--display); font-size: 15px; font-weight: 800; letter-spacing:-0.01em; color: #fff; }
    .mini-meta { margin-top: 4px; font-size: 12px; color: var(--muted); display:flex; flex-wrap:wrap; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-size: 11.5px; font-weight: 700;
      background: rgba(99,102,241,0.10); border: 1px solid rgba(99,102,241,0.22); color: var(--accent2); }
    .pill.soft { background: rgba(255,255,255,0.04); border-color: rgba(150,160,255,0.18); color: var(--muted); font-weight:600; }
    .mini-actions { display:flex; gap:6px; }
    .mini-actions .btn-ghost { padding: 7px 10px; font-size: 12px; border-radius: 10px; }
    .mini-actions .danger { border-color: rgba(248,113,113,0.55); color: var(--bad); }
    .note-mini { margin-top: 8px; font-size: 12px; color: var(--muted2); line-height: 1.45; }

  
    /* Golf (inline tab) */
    .golf-grid { display:grid; grid-template-columns: 420px 1fr; gap: 14px; }
    @media (max-width: 980px){ .golf-grid{ grid-template-columns: 1fr; } }
    .stat-row { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 640px){ .stat-row{ grid-template-columns: 1fr; } }

</style>

  <style>
    html.auth-pending body { visibility: hidden; }
  
    /* Golf (inline tab) */
    .golf-grid { display:grid; grid-template-columns: 420px 1fr; gap: 14px; }
    @media (max-width: 980px){ .golf-grid{ grid-template-columns: 1fr; } }
    .stat-row { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 640px){ .stat-row{ grid-template-columns: 1fr; } }

</style>

</head>
<body>

<header class="topbar">
  <!-- Left: Brand -->
  <div class="brand">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13 2L4.5 13.5H10.5L9 22L19.5 10.5H13.5L15 2H13Z"
          fill="white" fill-opacity="0.96"
          stroke="rgba(255,255,255,0.25)" stroke-width="0.4" stroke-linejoin="round"/>
        <path d="M10.5 13.5L9 22L12.5 17.5L10.5 13.5Z"
          fill="rgba(196,181,253,0.75)"/>
      </svg>
    </div>
    <div class="brand-text">
      <div class="brand-name">Trainify</div>
      <div class="brand-sub">Training Hub</div>
    </div>
  </div>

  <!-- Center: Nav -->
  <nav class="nav-tabs nav-center">
    <button class="nav-tab active" id="tabDash"  type="button">Dashboard</button>
    <button class="nav-tab"        id="tabLogg"  type="button">Tr√§ningslogg</button>
    <button class="nav-tab"        id="tabGolf"  type="button">Golf</button>
  </nav>

  <!-- Right: Status pills -->
  <div class="topbar-right">
    <div class="status-pill"><span class="status-dot"></span>Live</div>
    <div class="status-pill" id="pillYear">√Ör: ‚Äî</div>
    <button class="btn-ghost" id="btnSignOut" type="button" style="margin-left:8px;">Logga ut</button>
  </div>
</header>

<div class="page-wrap">

  <!-- FORM centered top -->
  <div class="top-form-row">
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">L√§gg till pass</div>
          <div class="panel-subtitle">Registrera ett nytt tr√§ningspass manuellt.</div>
        </div>
      </div>
      <div class="panel-body">
        <form id="activity-form" class="form" autocomplete="off">

          <div class="field">
            <label class="field-label">Datum &amp; tid</label>
            <div class="date-picker-wrap">
              <div class="date-display" id="dateDisplay" tabindex="0" role="button" aria-label="V√§lj datum och tid">
                <span id="dateDisplayText" class="placeholder">V√§lj datum &amp; tid‚Ä¶</span>
                <span class="cal-icon">üìÖ</span>
              </div>
              <div class="calendar-popup" id="calendarPopup">
                <div class="cal-top">
                  <button class="cal-nav-btn" id="calPrev" type="button">‚Äπ</button>
                  <span class="cal-month-label" id="calMonthLabel"></span>
                  <button class="cal-nav-btn" id="calNext" type="button">‚Ä∫</button>
                </div>
                <div class="cal-grid">
                  <div class="cal-weekdays">
                    <div class="cal-wd">M√•n</div><div class="cal-wd">Tis</div><div class="cal-wd">Ons</div>
                    <div class="cal-wd">Tor</div><div class="cal-wd">Fre</div><div class="cal-wd">L√∂r</div>
                    <div class="cal-wd">S√∂n</div>
                  </div>
                  <div class="cal-days" id="calDays"></div>
                </div>
                <div class="cal-time">
                  <div>
                    <div class="cal-time-label">Klockslag</div>
                    <div class="cal-time-inputs">
                      <input type="number" id="calHour"   min="0" max="23" placeholder="HH" value="12">
                      <input type="number" id="calMinute" min="0" max="59" placeholder="MM" value="00">
                    </div>
                  </div>
                  <button class="cal-confirm" id="calConfirm" type="button">Bekr√§fta</button>
                </div>
              </div>
            </div>
            <input type="hidden" id="start_time" required />
          </div>

          <div class="field">
            <label class="field-label" for="sport">Sport</label>
            <select id="sport" required>
              <option value="L√∂pning">üèÉ L√∂pning</option>
              <option value="Styrketr√§ning">üí™ Styrketr√§ning</option>
            </select>
          </div>

          <div class="field">
            <label class="field-label" for="name">Passnamn (valfritt)</label>
            <input type="text" id="name" placeholder="t.ex. Intervaller / Helkropp" />
          </div>

          <div class="row3">
            <div class="field">
              <label class="field-label" for="duration_h">Timmar</label>
              <input type="number" id="duration_h" min="0" placeholder="0" />
            </div>
            <div class="field">
              <label class="field-label" for="duration_min">Minuter</label>
              <input type="number" id="duration_min" min="0" max="59" placeholder="45" />
            </div>
            <div class="field">
              <label class="field-label" for="distance_km">Distans (km)</label>
              <input type="number" id="distance_km" min="0" step="0.01" placeholder="10.00" />
            </div>
          </div>

          <div class="hint-text">Tempo (min/km) ber√§knas automatiskt om distans + tid finns.</div>

          <div class="field">
            <label class="field-label" for="notes">Anteckningar (valfritt)</label>
            <input type="text" id="notes" placeholder="K√§nsla, uppl√§gg, vikter‚Ä¶" />
          </div>

          <button class="btn-primary" type="submit">Spara pass</button>
          <div id="msg" class="msg" aria-live="polite"></div>
        </form>
      </div>
      <div class="panel-footer">Importerade aktiviteter skapar inga dubletter vid omimport.</div>
    </section>
  </div>

  <!-- DASHBOARD / LOG -->
  <div class="main-content">
  <div class="panel" style="padding:0; overflow:visible;">
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="chip chip-accent" id="countChip">‚Äî pass</div>
        <div class="chip" id="lastChip">Senast: ‚Äî</div>
      </div>
      <div class="toolbar-right year-select-wrap">
        <select id="yearSelect"><option value="">√Ör‚Ä¶</option></select>
        <button class="btn-ghost" id="reloadBtn" type="button">‚Üª Uppdatera</button>
      </div>
    </div>

    <div class="view active" id="viewDash">
      <div class="panel-body" style="padding-top:22px; padding-bottom:22px;">
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Totalt antal pass</div>
            <div class="stat-value" id="statTotalSessions">‚Äî</div>
            <div class="stat-sub" id="subYear">Valda √•ret</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-label">Total tid</div>
            <div class="stat-value" id="statTotalHours">‚Äî<span class="stat-unit">h</span></div>
            <div class="stat-sub">Valda √•ret</div>
          </div>
          <div class="stat-card violet">
            <div class="stat-label">L√∂pning distans</div>
            <div class="stat-value" id="statRunKm">‚Äî<span class="stat-unit">km</span></div>
            <div class="stat-sub">Valda √•ret</div>
          </div>
        </div>
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-card-header">
              <div class="chart-card-title"><span class="sport-badge run">üèÉ L√∂pning</span></div>
              <div class="chart-card-meta">Str√§cka (mil) + tid / m√•nad</div>
            </div>
            <div class="chart-wrap"><canvas id="chartRun"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-card-header">
              <div class="chart-card-title"><span class="sport-badge strength">üí™ Styrketr√§ning</span></div>
              <div class="chart-card-meta">Totala timmar / m√•nad</div>
            </div>
            <div class="chart-wrap"><canvas id="chartStrength"></canvas></div>
          </div>
        </div>

        <div class="records-grid">
          <!-- Personal Records -->
          <section class="records-card">
            <div class="records-card-hdr lock-row">
              <div>
                <div class="records-card-title">üèÖ Personliga rekord</div>
                <div class="records-card-sub">Spara dina b√§sta tider ‚Äì visas som en snygg lista.</div>
              </div>
              <div class="pill soft lock-pill" id="lockPill" title="Klicka f√∂r att l√•sa upp redigering">üîí L√•st</div>
            </div>
            <div class="records-body">
              <form id="prForm" class="mini-form" autocomplete="off">
                <div class="row2">
                  <div class="field">
                    <label class="field-label" for="prType">Distans</label>
                    <select id="prType" required>
                      <option value="5 km">5 km</option>
                      <option value="10 km">10 km</option>
                      <option value="Halvmarathon">Halvmarathon</option>
                      <option value="Marathon">Marathon</option>
                      <option value="Ultra">Ultra</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="field-label" for="prTime">Tid (hh:mm:ss)</label>
                    <input id="prTime" type="text" placeholder="t.ex. 00:19:45" required />
                  </div>
                </div>
                <div class="row3">
                  <div class="field">
                    <label class="field-label" for="prDate">Datum</label>
                    <input id="prDate" type="date" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="prEvent">T√§vling (valfritt)</label>
                    <input id="prEvent" type="text" placeholder="t.ex. G√∂teborgsvarvet" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="prNotes">Notis</label>
                    <input id="prNotes" type="text" placeholder="t.ex. bra form / kuperat" />
                  </div>
                </div>
                <button class="btn-primary" type="submit" id="prSubmitBtn">Spara PR</button>
                <div id="prMsg" class="msg" aria-live="polite"></div>
              </form>

              <div class="list-mini" id="prList">
                <div class="empty-state" style="margin:0; padding:18px 14px;">
                  <div class="empty-state-icon">‚ú®</div>
                  <div class="empty-state-title">Inga PR √§nnu</div>
                  <div class="empty-state-sub">L√§gg in din b√§sta tid s√• dyker den upp h√§r.</div>
                </div>
              
              <div class="pr-trend">
                <div class="pr-trend-top">
                  <div class="pr-trend-title">PR-trend</div>
                  <select id="prTrendSelect" aria-label="V√§lj distans f√∂r PR-trend">
                    <option value="5 km">5 km</option>
                    <option value="10 km">10 km</option>
                    <option value="Halvmarathon">Halvmarathon</option>
                    <option value="Marathon">Marathon</option>
                    <option value="Ultra">Ultra</option>
                  </select>
                </div>
                <div class="pr-trend-canvas"><canvas id="chartPRTrend"></canvas></div>
              </div>

            </div>
          </section>

          <!-- Race Results -->
          <section class="records-card">
            <div class="records-card-hdr">
              <div>
                <div class="records-card-title">üèÅ T√§vlingar & resultat</div>
                <div class="records-card-sub">Logga lopp, distanser och tider ‚Äì perfekt f√∂r historik.</div>
              </div>
              <div class="pill soft">RACE</div>
            </div>
            <div class="records-body">
              <form id="raceForm" class="mini-form" autocomplete="off">
                <div class="row2">
                  <div class="field">
                    <label class="field-label" for="raceName">T√§vling / pass</label>
                    <input id="raceName" type="text" placeholder="t.ex. Liding√∂loppet" required />
                  </div>
                  <div class="field">
                    <label class="field-label" for="raceDistance">Distans</label>
                    <input id="raceDistance" type="text" placeholder="t.ex. 15 km / 5 km / 50 km" required />
                  </div>
                </div>
                <div class="row3">
                  <div class="field">
                    <label class="field-label" for="raceTime">Tid (hh:mm:ss)</label>
                    <input id="raceTime" type="text" placeholder="t.ex. 01:29:10" required />
                  </div>
                  <div class="field">
                    <label class="field-label" for="raceDate">Datum</label>
                    <input id="raceDate" type="date" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="raceLocation">Plats (valfritt)</label>
                    <input id="raceLocation" type="text" placeholder="t.ex. Stockholm" />
                  </div>
                </div>
                <div class="field">
                  <label class="field-label" for="raceNotes">Anteckningar (valfritt)</label>
                  <input id="raceNotes" type="text" placeholder="t.ex. v√§der, uppl√§gg, placering‚Ä¶" />
                </div>
                <button class="btn-primary" type="submit" id="raceSubmitBtn">Spara resultat</button>
                <div id="raceMsg" class="msg" aria-live="polite"></div>
              </form>

              <div class="list-mini" id="raceList">
                <div class="empty-state" style="margin:0; padding:18px 14px;">
                  <div class="empty-state-icon">üóìÔ∏è</div>
                  <div class="empty-state-title">Inga t√§vlingar √§nnu</div>
                  <div class="empty-state-sub">N√§r du l√§gger till ett resultat visas det h√§r.</div>
                </div>
              </div>
            </div>
          </section>
        </div>

      </div>
    </div>

    <div class="view" id="viewLogg">
      <div class="section-hdr">
        <div class="section-hdr-title">Senaste pass</div>
        <div class="section-hdr-sub">Visar upp till 60 pass</div>
      </div>
      <div id="activities" class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-title">Laddar aktiviteter‚Ä¶</div>
      </div>
    </div>
  
    <div class="view" id="viewGolf">
      <div class="panel-body" style="padding-top:22px; padding-bottom:22px;">
        <div class="golf-grid">
          <!-- Left: form -->
          <section class="panel" style="margin:0;">
            <div class="panel-header">
              <div>
                <div class="panel-title">‚õ≥ Ny runda</div>
                <div class="panel-subtitle">L√§gg in datum, bana, 9/18, slag, po√§ng och statistik.</div>
              </div>
            </div>
            <div class="panel-body">
              <form id="golfForm" class="form" autocomplete="off">
                <div class="row2">
                  <div class="field">
                    <label class="field-label" for="gDate">Datum</label>
                    <input id="gDate" type="date" required />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gCourse">Bana</label>
                    <input id="gCourse" type="text" placeholder="t.ex. Bro Hof" required />
                  </div>
                </div>

                <div class="row2">
                  <div class="field">
                    <label class="field-label" for="gHoles">H√•l</label>
                    <select id="gHoles" required>
                      <option value="9">9 h√•l</option>
                      <option value="18" selected>18 h√•l</option>
                    </select>
                  </div>
                  <div class="field">
                    <label class="field-label" for="gWeather">V√§der</label>
                    <input id="gWeather" type="text" placeholder="t.ex. sol, 8¬∞C, vind" />
                  </div>
                </div>

                <div class="row2">
                  <div class="field">
                    <label class="field-label" for="gStrokes">Antal slag</label>
                    <input id="gStrokes" type="number" min="1" step="1" placeholder="t.ex. 92" required />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gPoints">Po√§ng</label>
                    <input id="gPoints" type="number" min="0" step="1" placeholder="t.ex. 32" />
                  </div>
                </div>

                <div class="stat-row">
                  <div class="field">
                    <label class="field-label" for="gDoubleBogey">Dubbelbogey</label>
                    <input id="gDoubleBogey" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gBogey">Bogey</label>
                    <input id="gBogey" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gPar">Par</label>
                    <input id="gPar" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gBirdie">Birdie</label>
                    <input id="gBirdie" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gEagle">Eagle</label>
                    <input id="gEagle" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label class="field-label" for="gNotes">Notis</label>
                    <input id="gNotes" type="text" placeholder="t.ex. nya j√§rn, bra puttning" />
                  </div>
                </div>

                <button class="btn-primary" type="submit" id="gSubmit">Spara runda</button>
                <div id="gMsg" class="msg" aria-live="polite"></div>
              </form>
            </div>
            <div class="panel-footer">Tips: Summan av DB+B+P+Bi+E b√∂r matcha 9/18.</div>
          </section>

          <!-- Right: stats + list -->
          <div style="display:grid; gap:14px;">
            <section class="panel" style="margin:0;">
              <div class="panel-header">
                <div>
                  <div class="panel-title">üìà Statistik</div>
                  <div class="panel-subtitle">Slag (stark) + po√§ng (blekare) √∂ver tid, och f√∂rdelning av resultat.</div>
                </div>
              </div>
              <div class="panel-body">
                <div class="row2" style="align-items:end;">
                  <div class="field">
                    <label class="field-label" for="gFilterHoles">Filter</label>
                    <select id="gFilterHoles">
                      <option value="all" selected>Alla rundor</option>
                      <option value="18">Endast 18 h√•l</option>
                      <option value="9">Endast 9 h√•l</option>
                    </select>
                  </div>
                  <div class="hint-text" id="gStatHint">‚Äî</div>
                </div>
                <div style="position:relative; height:220px; margin-top:10px;"><canvas id="chartGolfTrend"></canvas></div>
                <div style="position:relative; height:220px; margin-top:14px;"><canvas id="chartGolfDist"></canvas></div>
              </div>
              <div class="panel-footer">Trend: slag (stark) + po√§ng (blekare).</div>
            </section>

            <section class="panel" style="margin:0;">
              <div class="panel-header">
                <div>
                  <div class="panel-title">üìí Rundor</div>
                  <div class="panel-subtitle">Senaste rundorna (redigera / radera).</div>
                </div>
              </div>
              <div class="panel-body">
                <div id="golfList" class="list-mini"></div>
              </div>
              <div class="panel-footer">Tabell: <code>golf_rounds</code> (Supabase)</div>
            </section>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main-content -->

</div><!-- /page-wrap -->

<script>
const SUPABASE_URL      = "https://pmstnkmloyipsrveqidg.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Mb-z3MZvMP_KC09dMXE-AQ_AauF362I";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ‚îÄ‚îÄ Supabase Auth Gate ‚îÄ‚îÄ
   Den h√§r sidan visar inget innan en giltig session finns.
   Om ingen session: redirect till index.html
*/
document.documentElement.classList.add("auth-pending");

async function requireSession(){
  const { data, error } = await sb.auth.getSession();
  if(error){
    console.error(error);
    location.href = "index.html?err=1";
    return;
  }
  const user = data?.session?.user;
  window.currentUser = user || null;
  if(!user){
    location.href = "index.html";
    return;
  }
  document.documentElement.classList.remove("auth-pending");
}

await requireSession();

const btnSignOut = document.getElementById("btnSignOut");
if(btnSignOut){
  btnSignOut.addEventListener("click", async ()=>{
    await sb.auth.signOut();
    location.href = "index.html?logout=1";
  });
}


const form              = document.getElementById("activity-form");
const msg               = document.getElementById("msg");
const reloadBtn         = document.getElementById("reloadBtn");
const yearSelect        = document.getElementById("yearSelect");
const countChip         = document.getElementById("countChip");
const lastChip          = document.getElementById("lastChip");
const pillYear          = document.getElementById("pillYear");
const subYear           = document.getElementById("subYear");
const statTotalSessions = document.getElementById("statTotalSessions");
const statTotalHours    = document.getElementById("statTotalHours");
const statRunKm         = document.getElementById("statRunKm");
const tabDash           = document.getElementById("tabDash");
const tabLogg           = document.getElementById("tabLogg");
const tabGolf           = document.getElementById("tabGolf");
const viewDash          = document.getElementById("viewDash");
const viewLogg          = document.getElementById("viewLogg");
const viewGolf          = document.getElementById("viewGolf");
const activitiesDiv     = document.getElementById("activities");

const monthLabels = ["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];
const monthNamesFull = ["Januari","Februari","Mars","April","Maj","Juni","Juli","Augusti","September","Oktober","November","December"];
let chartRun = null, chartStrength = null;

Chart.defaults.color = "rgba(123,132,184,0.9)";
Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
Chart.defaults.font.size = 11;

/* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
const dateDisplay     = document.getElementById("dateDisplay");
const dateDisplayText = document.getElementById("dateDisplayText");
const calendarPopup   = document.getElementById("calendarPopup");
const calDaysEl       = document.getElementById("calDays");
const calMonthLabel   = document.getElementById("calMonthLabel");
const calPrev         = document.getElementById("calPrev");
const calNext         = document.getElementById("calNext");
const calHour         = document.getElementById("calHour");
const calMinute       = document.getElementById("calMinute");
const calConfirm      = document.getElementById("calConfirm");
const hiddenStart     = document.getElementById("start_time");

let calView     = new Date();
let calSelected = new Date();

function renderCalendar() {
  const y = calView.getFullYear(), m = calView.getMonth();
  calMonthLabel.textContent = `${monthNamesFull[m]} ${y}`;
  calDaysEl.innerHTML = "";
  const today    = new Date();
  const firstDay = new Date(y, m, 1);
  let offset = firstDay.getDay() - 1;
  if (offset < 0) offset = 6;

  const prevLast = new Date(y, m, 0).getDate();
  for (let i = offset - 1; i >= 0; i--) {
    calDaysEl.appendChild(mkDay(new Date(y, m-1, prevLast-i), "other-month"));
  }

  const dim = new Date(y, m+1, 0).getDate();
  for (let d = 1; d <= dim; d++) {
    const date = new Date(y, m, d);
    const cls = [];
    if (date.toDateString() === today.toDateString()) cls.push("today");
    if (calSelected && date.toDateString() === calSelected.toDateString()) cls.push("selected");
    calDaysEl.appendChild(mkDay(date, cls.join(" ")));
  }

  const total = Math.ceil((offset + dim) / 7) * 7;
  for (let d = 1; d <= total - offset - dim; d++) {
    calDaysEl.appendChild(mkDay(new Date(y, m+1, d), "other-month"));
  }
}

function mkDay(date, cls) {
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = `cal-day ${cls}`.trim();
  btn.textContent = date.getDate();
  btn.addEventListener("click", () => { calSelected = date; renderCalendar(); });
  return btn;
}

calPrev.addEventListener("click", () => { calView = new Date(calView.getFullYear(), calView.getMonth()-1, 1); renderCalendar(); });
calNext.addEventListener("click", () => { calView = new Date(calView.getFullYear(), calView.getMonth()+1, 1); renderCalendar(); });

dateDisplay.addEventListener("click", (e) => {
  e.stopPropagation();
  const open = calendarPopup.classList.toggle("open");
  dateDisplay.classList.toggle("open", open);
  if (open) renderCalendar();
});

calConfirm.addEventListener("click", () => {
  if (!calSelected) return;
  const h   = Math.min(23, Math.max(0, Number(calHour.value)   || 0));
  const min = Math.min(59, Math.max(0, Number(calMinute.value) || 0));
  const fd  = new Date(calSelected.getFullYear(), calSelected.getMonth(), calSelected.getDate(), h, min);
  hiddenStart.value = fd.toISOString().slice(0, 16);
  const pad = n => String(n).padStart(2, "0");
  dateDisplayText.textContent = `${calSelected.toLocaleDateString("sv-SE")}  ${pad(h)}:${pad(min)}`;
  dateDisplayText.classList.remove("placeholder");
  calendarPopup.classList.remove("open");
  dateDisplay.classList.remove("open");
});

document.addEventListener("click", (e) => {
  if (!calendarPopup.contains(e.target) && e.target !== dateDisplay && !dateDisplay.contains(e.target)) {
    calendarPopup.classList.remove("open");
    dateDisplay.classList.remove("open");
  }
});

// Init default time to now
calHour.value   = new Date().getHours();
calMinute.value = String(new Date().getMinutes()).padStart(2, "0");

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function setMessage(t, err=false){ msg.textContent=t||""; msg.style.color=err?"var(--bad)":"var(--good)"; }
function safeText(v){ const s=document.createElement("span"); s.textContent=(v??'').toString(); return s.innerHTML; }
function formatDistance(m){ if(!m||m<=0)return null; const k=m/1000; return `${k.toFixed(k<10?2:1)} km`; }
function formatDuration(s){ if(!s||s<=0)return null; const h=Math.floor(s/3600),m=Math.floor((s%3600)/60); return h>0?`${h}h ${m}m`:`${m}m`; }
function calcPace(dur,dist){ if(!dur||!dist||dist<=0)return null; const s=dur/(dist/1000); if(!isFinite(s))return null; return `${Math.floor(s/60)}:${Math.round(s%60).toString().padStart(2,"0")} min/km`; }
function toHours(s){ return(!s||s<=0)?0:s/3600; }
function yearsFromActivities(list){ const ys=new Set(); for(const a of list){ const d=new Date(a.start_time); if(!isNaN(d.getTime()))ys.add(d.getFullYear()); } return Array.from(ys).sort((a,b)=>b-a); }
/* ‚îÄ‚îÄ PR & Race helpers ‚îÄ‚îÄ */
const prForm = document.getElementById("prForm");
const prList = document.getElementById("prList");
const prMsg  = document.getElementById("prMsg");
const prSubmitBtn = document.getElementById("prSubmitBtn");

const raceForm = document.getElementById("raceForm");
const raceList = document.getElementById("raceList");
const raceMsg  = document.getElementById("raceMsg");
const raceSubmitBtn = document.getElementById("raceSubmitBtn");

let prTrendChart = null;
const lockPill = document.getElementById("lockPill");
const prTrendSelect = document.getElementById("prTrendSelect");
const chartPRTrendCanvas = document.getElementById("chartPRTrend");

/* ‚îÄ‚îÄ Simple edit lock (UI-level) ‚îÄ‚îÄ
   NOTE: This is NOT real security. For real security, use Supabase Auth + per-user RLS.
*/
const EDIT_PIN = "1234"; // √Ñndra till din egen kod
let editUnlocked = false;

function applyEditLock(){
  const prCard = lockPill ? lockPill.closest(".records-card") : null;
  const raceCard = document.getElementById("raceForm") ? document.getElementById("raceForm").closest(".records-card") : null;
  const locked = !editUnlocked;
  if(prCard) prCard.classList.toggle("locked", locked);
  if(raceCard) raceCard.classList.toggle("locked", locked);
  if(lockPill){
    lockPill.textContent = locked ? "üîí L√•st" : "üîì Uppl√•st";
    lockPill.title = locked ? "Klicka f√∂r att l√•sa upp redigering" : "Klicka f√∂r att l√•sa";
    lockPill.classList.toggle("chip-accent", !locked);
  }
  // Disable submit buttons when locked (still allow typing)
  if(prSubmitBtn) prSubmitBtn.disabled = locked;
  if(raceSubmitBtn) raceSubmitBtn.disabled = locked;
}

if(lockPill){
  lockPill.addEventListener("click", ()=>{
    if(editUnlocked){
      editUnlocked = false;
      applyEditLock();
      setMiniMessage(prMsg, "L√•st üîí");
      setMiniMessage(raceMsg, "L√•st üîí");
      return;
    }
    const pin = prompt("Ange PIN f√∂r att l√•sa upp redigering:");
    if(pin === EDIT_PIN){
      editUnlocked = true;
      applyEditLock();
      setMiniMessage(prMsg, "Uppl√•st ‚úì");
      setMiniMessage(raceMsg, "Uppl√•st ‚úì");
    }else if(pin != null){
      setMiniMessage(prMsg, "Fel PIN.", true);
    }
  });
}

function distIcon(type){
  const t = (type||"").toLowerCase();
  if(t.includes("5")) return "5K";
  if(t.includes("10")) return "10K";
  if(t.includes("halv")) return "HM";
  if(t.includes("mara")) return "M";
  if(t.includes("ultra")) return "ULTRA";
  return "PR";
}

function bestByType(prs){
  const map = new Map();
  for(const r of prs){
    const key = r.type || "";
    if(!map.has(key) || (r.time_s != null && r.time_s < map.get(key).time_s)){
      map.set(key, r);
    }
  }
  return map;
}

function buildPRTrend(prs, type){
  const filtered = prs.filter(r => (r.type||"") === type && r.time_s != null);
  // Prefer date ordering; fallback to created_at
  filtered.sort((a,b)=>{
    const da = a.date ? new Date(a.date) : new Date(a.created_at || 0);
    const db = b.date ? new Date(b.date) : new Date(b.created_at || 0);
    return da - db;
  });
  const labels = filtered.map(r => r.date ? r.date : (r.created_at ? new Date(r.created_at).toISOString().slice(0,10) : ""));
  const data = filtered.map(r => Math.round(r.time_s/1)/1);
  return { labels, data };
}

function renderPRTrend(prs){
  if(!chartPRTrendCanvas || !window.Chart) return;
  const type = prTrendSelect ? prTrendSelect.value : "5 km";
  const t = buildPRTrend(prs, type);
  if(prTrendChart) prTrendChart.destroy();

  // If not enough points, show empty-ish chart
  prTrendChart = new Chart(chartPRTrendCanvas,{
    type:"line",
    data:{
      labels: t.labels.length ? t.labels : ["‚Äî"],
      datasets:[{
        label:`Tid (${type})`,
        data: t.data.length ? t.data : [null],
        borderColor:"rgba(167,139,250,0.85)",
        backgroundColor:"rgba(167,139,250,0.10)",
        pointBackgroundColor:"rgba(167,139,250,0.90)",
        pointBorderColor:"rgba(13,15,28,1)",
        pointBorderWidth:2,
        pointRadius:3,
        tension:0.35,
        fill:true
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{
          backgroundColor:"rgba(7,8,15,0.96)",
          borderColor:"rgba(167,139,250,0.20)",
          borderWidth:1,
          titleColor:"rgba(232,234,248,0.95)",
          bodyColor:"rgba(123,132,184,0.9)",
          padding:12,
          cornerRadius:12,
          callbacks:{
            label:(ctx)=>` ${formatHms(ctx.parsed.y)}`
          }
        }
      },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)"}, border:{display:false},
            ticks:{color:"rgba(123,132,184,0.65)", maxTicksLimit:6} },
        y:{ grid:{color:"rgba(99,102,241,0.07)"}, border:{display:false},
            ticks:{color:"rgba(123,132,184,0.65)", callback:(v)=>formatHms(v)} }
      }
    }
  });
}

if(prTrendSelect){
  prTrendSelect.addEventListener("change", async ()=>{
    try{
      const prs = await fetchPRs();
      renderPRTrend(prs);
    }catch(e){}
  });
}


function setMiniMessage(el, t, err=false){
  if(!el) return;
  el.textContent = t || "";
  el.style.color = err ? "var(--bad)" : "var(--good)";
}

function parseHmsToSeconds(str){
  if(!str) return null;
  const s = String(str).trim();
  // Accept mm:ss or hh:mm:ss
  const parts = s.split(":").map(p=>p.trim()).filter(Boolean);
  if(parts.length<2 || parts.length>3) return null;
  const nums = parts.map(p=>Number(p));
  if(nums.some(n=>!isFinite(n) || n<0)) return null;
  let h=0,m=0,sec=0;
  if(parts.length===2){ m=nums[0]; sec=nums[1]; }
  else { h=nums[0]; m=nums[1]; sec=nums[2]; }
  if(m>59 || sec>59) return null;
  return Math.floor(h)*3600 + Math.floor(m)*60 + Math.floor(sec);
}

function formatHms(seconds){
  if(seconds==null || !isFinite(seconds) || seconds<0) return "‚Äî";
  const s=Math.floor(seconds);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const sec=s%60;
  const pad=n=>String(n).padStart(2,"0");
  return h>0 ? `${pad(h)}:${pad(m)}:${pad(sec)}` : `${pad(m)}:${pad(sec)}`;
}

/* ‚îÄ‚îÄ Supabase: PR ‚îÄ‚îÄ
   Table suggestion:
   personal_records: id (uuid), type (text), time_s (int), date (date), event (text), notes (text), created_at (timestamptz default now())
*/
async function fetchPRs(){
  if(!window.currentUser) return [];
  const { data, error } = await sb.from("personal_records")
    .select("id,type,time_s,date,event,notes,created_at")
    .eq("user_id", window.currentUser.id)
    .order("time_s",{ascending:true})
    .limit(50);
  if(error) throw error;
  return data || [];
}

function renderPRs(list){
  if(!prList) return;
  if(!list.length){
    prList.innerHTML = `
      <div class="empty-state" style="margin:0; padding:18px 14px;">
        <div class="empty-state-icon">‚ú®</div>
        <div class="empty-state-title">Inga PR √§nnu</div>
        <div class="empty-state-sub">L√§gg in din b√§sta tid s√• dyker den upp h√§r.</div>
      </div>`;
    return;
  }
  prList.innerHTML = "";
  const bestMap = (typeof bestByType === "function") ? bestByType(list) : new Map();
  for(const r of list){
    const metaParts = [];
    if(r.date) metaParts.push(`<span class="pill soft">üìÖ ${safeText(r.date)}</span>`);
    if(r.event) metaParts.push(`<span class="pill soft">üèÅ ${safeText(r.event)}</span>`);
    const notes = r.notes ? `<div class="note-mini">${safeText(r.notes)}</div>` : "";
    const el = document.createElement("div");
    const isBest = bestMap.get(r.type || "")?.id === r.id;
    el.className = "mini-item" + (isBest ? " best" : "");
    el.innerHTML = `
      <div class="mini-main">
        <div class="mini-top">
          <div class="mini-name">üèÉ <span class="pill" style="padding:3px 9px;">${safeText(distIcon(r.type))}</span> ${safeText(r.type || "")} ${isBest ? '<span class="badge-best">üèÜ B√§sta</span>' : ''}</div>
          <div class="mini-time">${formatHms(r.time_s)}</div>
        </div>
        <div class="mini-meta">${metaParts.join("")}</div>
        ${notes}
      </div>
      <div class="mini-actions">
        <button class="btn-ghost" type="button" onclick="editPR('${r.id}')">‚úèÔ∏è</button>
        <button class="btn-ghost danger" type="button" onclick="deletePR('${r.id}')">üóë</button>
      </div>`;
    prList.appendChild(el);
  }
}

async function upsertPR(payload, id=null){
  if(id){
    const { error } = await sb.from("personal_records").update(payload).eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
  } else {
    const { error } = await sb.from("personal_records").insert({ ...payload, user_id: window.currentUser.id });
    if(error) throw error;
  }
}

async function deletePR(id){
  if(!editUnlocked){ setMiniMessage(prMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
  if(!confirm("Radera PR?")) return;
  try{
    const { error } = await sb.from("personal_records").delete().eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
    setMiniMessage(prMsg, "PR raderat ‚úì");
    await loadPRs();
  }catch(e){ setMiniMessage(prMsg, e?.message||"Kunde inte radera", true); }
}

async function editPR(id){
  if(!editUnlocked){ setMiniMessage(prMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
  try{
    const { data, error } = await sb.from("personal_records")
      .select("id,type,time_s,date,event,notes").eq("id", id).eq("user_id", window.currentUser.id).single();
    if(error) throw error;
    prForm.dataset.editId = data.id;
    document.getElementById("prType").value = data.type || "5 km";
    document.getElementById("prTime").value = formatHms(data.time_s);
    document.getElementById("prDate").value = data.date || "";
    document.getElementById("prEvent").value = data.event || "";
    document.getElementById("prNotes").value = data.notes || "";
    prSubmitBtn.textContent = "Uppdatera PR";
    setMiniMessage(prMsg, "Redigerar PR‚Ä¶");
  }catch(e){ setMiniMessage(prMsg, e?.message||"Kunde inte h√§mta", true); }
}

async function loadPRs(){
  try{
    const prs = await fetchPRs();
    renderPRs(prs);
    if(prTrendSelect) prTrendSelect.value = prTrendSelect.value || "5 km";
    renderPRTrend(prs);
  }catch(e){
    // Graceful error message + hint about table
    if(prList){
      prList.innerHTML = `
        <div class="empty-state" style="margin:0; padding:18px 14px;">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div class="empty-state-title">PR saknar tabell</div>
          <div class="empty-state-sub">${safeText(e?.message||"Skapa tabellen 'personal_records' i Supabase f√∂r att spara PR.")}</div>
        </div>`;
    }
  }
}

if(prForm){
  prForm.addEventListener("submit", async (e)=>{
    if(!editUnlocked){ setMiniMessage(prMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
    e.preventDefault();
    setMiniMessage(prMsg,"");
    const type = document.getElementById("prType").value;
    const time_s = parseHmsToSeconds(document.getElementById("prTime").value);
    if(time_s==null){ setMiniMessage(prMsg,"Ange tid som mm:ss eller hh:mm:ss.", true); return; }
    const date = document.getElementById("prDate").value || null;
    const event = document.getElementById("prEvent").value.trim() || null;
    const notes = document.getElementById("prNotes").value.trim() || null;

    const payload = { type, time_s, date, event, notes };
    const editId = prForm.dataset.editId || null;

    try{
      await upsertPR(payload, editId);
      prForm.reset();
      delete prForm.dataset.editId;
      prSubmitBtn.textContent = "Spara PR";
      setMiniMessage(prMsg, editId ? "PR uppdaterat ‚úì" : "PR sparat ‚úì");
      await loadPRs();
    }catch(err){
      setMiniMessage(prMsg, err?.message||"Kunde inte spara", true);
    }
  });
}

/* ‚îÄ‚îÄ Supabase: Race results ‚îÄ‚îÄ
   Table suggestion:
   race_results: id (uuid), name (text), distance (text), time_s (int), date (date), location (text), notes (text), created_at (timestamptz default now())
*/
async function fetchRaces(){
  if(!window.currentUser) return [];
  const { data, error } = await sb.from("race_results")
    .select("id,name,distance,time_s,date,location,notes,created_at")
    .eq("user_id", window.currentUser.id)
    .order("date",{ascending:false})
    .limit(60);
  if(error) throw error;
  return data || [];
}

function renderRaces(list){
  if(!raceList) return;
  if(!list.length){
    raceList.innerHTML = `
      <div class="empty-state" style="margin:0; padding:18px 14px;">
        <div class="empty-state-icon">üóìÔ∏è</div>
        <div class="empty-state-title">Inga t√§vlingar √§nnu</div>
        <div class="empty-state-sub">N√§r du l√§gger till ett resultat visas det h√§r.</div>
      </div>`;
    return;
  }
  raceList.innerHTML = "";
  for(const r of list){
    const metaParts = [];
    if(r.date) metaParts.push(`<span class="pill soft">üìÖ ${safeText(r.date)}</span>`);
    if(r.location) metaParts.push(`<span class="pill soft">üìç ${safeText(r.location)}</span>`);
    metaParts.push(`<span class="pill">üìè ${safeText(r.distance||"")}</span>`);

    const notes = r.notes ? `<div class="note-mini">${safeText(r.notes)}</div>` : "";

    const el = document.createElement("div");
    el.className="mini-item";
    el.innerHTML = `
      <div class="mini-main">
        <div class="mini-top">
          <div class="mini-name">${safeText(r.name||"")}</div>
          <div class="mini-time">${formatHms(r.time_s)}</div>
        </div>
        <div class="mini-meta">${metaParts.join("")}</div>
        ${notes}
      </div>
      <div class="mini-actions">
        <button class="btn-ghost" type="button" onclick="editRace('${r.id}')">‚úèÔ∏è</button>
        <button class="btn-ghost danger" type="button" onclick="deleteRace('${r.id}')">üóë</button>
      </div>`;
    raceList.appendChild(el);
  }
}

async function upsertRace(payload, id=null){
  if(id){
    const { error } = await sb.from("race_results").update(payload).eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
  } else {
    const { error } = await sb.from("race_results").insert({ ...payload, user_id: window.currentUser.id });
    if(error) throw error;
  }
}

async function deleteRace(id){
  if(!editUnlocked){ setMiniMessage(raceMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
  if(!confirm("Radera resultat?")) return;
  try{
    const { error } = await sb.from("race_results").delete().eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
    setMiniMessage(raceMsg, "Resultat raderat ‚úì");
    await loadRaces();
  }catch(e){ setMiniMessage(raceMsg, e?.message||"Kunde inte radera", true); }
}

async function editRace(id){
  if(!editUnlocked){ setMiniMessage(raceMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
  try{
    const { data, error } = await sb.from("race_results")
      .select("id,name,distance,time_s,date,location,notes").eq("id", id).eq("user_id", window.currentUser.id).single();
    if(error) throw error;
    raceForm.dataset.editId = data.id;
    document.getElementById("raceName").value = data.name || "";
    document.getElementById("raceDistance").value = data.distance || "";
    document.getElementById("raceTime").value = formatHms(data.time_s);
    document.getElementById("raceDate").value = data.date || "";
    document.getElementById("raceLocation").value = data.location || "";
    document.getElementById("raceNotes").value = data.notes || "";
    raceSubmitBtn.textContent = "Uppdatera resultat";
    setMiniMessage(raceMsg, "Redigerar resultat‚Ä¶");
  }catch(e){ setMiniMessage(raceMsg, e?.message||"Kunde inte h√§mta", true); }
}

async function loadRaces(){
  try{
    const races = await fetchRaces();
    renderRaces(races);
  }catch(e){
    if(raceList){
      raceList.innerHTML = `
        <div class="empty-state" style="margin:0; padding:18px 14px;">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div class="empty-state-title">T√§vlingar kan inte laddas</div>
          <div class="empty-state-sub">${safeText(e?.message||"Skapa tabellen 'race_results' i Supabase f√∂r att spara t√§vlingar.")}</div>
        </div>`;
    }
  }
}

if(raceForm){
  raceForm.addEventListener("submit", async (e)=>{
    if(!editUnlocked){ setMiniMessage(raceMsg, "L√•st üîí (klicka l√•set f√∂r att l√•sa upp)", true); return; }
    e.preventDefault();
    setMiniMessage(raceMsg,"");
    const name = document.getElementById("raceName").value.trim();
    const distance = document.getElementById("raceDistance").value.trim();
    const time_s = parseHmsToSeconds(document.getElementById("raceTime").value);
    if(!name || !distance){ setMiniMessage(raceMsg,"Ange namn och distans.", true); return; }
    if(time_s==null){ setMiniMessage(raceMsg,"Ange tid som mm:ss eller hh:mm:ss.", true); return; }

    const date = document.getElementById("raceDate").value || null;
    const location = document.getElementById("raceLocation").value.trim() || null;
    const notes = document.getElementById("raceNotes").value.trim() || null;

    const payload = { name, distance, time_s, date, location, notes };
    const editId = raceForm.dataset.editId || null;

    try{
      await upsertRace(payload, editId);
      raceForm.reset();
      delete raceForm.dataset.editId;
      raceSubmitBtn.textContent = "Spara resultat";
      setMiniMessage(raceMsg, editId ? "Resultat uppdaterat ‚úì" : "Resultat sparat ‚úì");
      await loadRaces();
    }catch(err){
      setMiniMessage(raceMsg, err?.message||"Kunde inte spara", true);
    }
  });
}




function ensureYearOptions(all){
  const ys=yearsFromActivities(all), cur=new Date().getFullYear();
  if(!ys.includes(cur))ys.unshift(cur);
  const sel=yearSelect.value; yearSelect.innerHTML="";
  for(const y of ys){ const o=document.createElement("option"); o.value=String(y); o.textContent=String(y); yearSelect.appendChild(o); }
  yearSelect.value=(sel&&ys.includes(Number(sel)))?sel:String(cur);
  pillYear.textContent=`√Ör: ${yearSelect.value}`;
  subYear.textContent=`Valt √•r: ${yearSelect.value}`;
}
function setSummary(list){
  countChip.textContent=`${list.length} pass`;
  if(list.length){ const l=new Date(list[0].start_time); lastChip.textContent=`Senast: ${l.toLocaleDateString()} ${l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`; }
  else lastChip.textContent="Senast: ‚Äî";
}
function buildYearBuckets(list,year){
  const init=()=>({counts:Array(12).fill(0),hours:Array(12).fill(0),runKm:Array(12).fill(0)});
  const out={"L√∂pning":init(),"Styrketr√§ning":init()};
  for(const a of list){
    const d=new Date(a.start_time); if(isNaN(d.getTime())||d.getFullYear()!==year)continue;
    const mo=d.getMonth(), sp=a.sport||"Ok√§nt"; if(!out[sp])continue;
    out[sp].counts[mo]+=1; out[sp].hours[mo]+=toHours(a.duration_s);
    if(sp==="L√∂pning"&&a.distance_m) out[sp].runKm[mo]+=(a.distance_m/10000); // mil
  }
  return out;
}


function makeHoursBarChart(canvasId, hours, pal, prev){
  const ctx=document.getElementById(canvasId);
  if(prev) prev.destroy();
  const mx=Math.max(...hours,1);
  return new Chart(ctx,{
    type:"bar",
    data:{
      labels:monthLabels,
      datasets:[{
        label:"Tid (h)",
        data:hours.map(v=>Math.round(v*10)/10),
        backgroundColor:hours.map(v=>pal.bar(0.25+0.75*(v/mx))),
        borderColor:"transparent",
        borderWidth:0,
        borderRadius:7,
        borderSkipped:false
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{ labels:{ color:"rgba(123,132,184,0.9)", font:{size:11,weight:'600'}, usePointStyle:true, pointStyle:'circle', boxWidth:8, boxHeight:8, padding:16 } },
        tooltip:{ backgroundColor:"rgba(7,8,15,0.96)", borderColor:"rgba(99,102,241,0.18)", borderWidth:1, titleColor:"rgba(232,234,248,0.95)", bodyColor:"rgba(123,132,184,0.9)", padding:13, cornerRadius:12, displayColors:true, boxWidth:8, boxHeight:8 }
      },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)", drawTicks:false}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", font:{size:11,weight:'600'}, padding:6} },
        y:{ beginAtZero:true, grid:{color:"rgba(99,102,241,0.07)", drawTicks:false}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", font:{size:10}, padding:8, maxTicksLimit:5} }
      }
    }
  });
}

function makeChart(canvasId, counts, hours, pal, prev){
  const ctx=document.getElementById(canvasId);
  if(prev) prev.destroy();
  const mx=Math.max(...counts,1);
  return new Chart(ctx,{
    type:"bar",
    data:{ labels:monthLabels, datasets:[
      { label:"Str√§cka (mil)", data:counts.map(v=>Math.round(v*10)/10), yAxisID:"yCount",
        backgroundColor:"rgba(255,159,64,0.92)",
        borderColor:"rgba(255,159,64,0.95)", borderWidth:1, borderRadius:7, borderSkipped:false, order:2 },
      { label:"Tid (h)", data:hours.map(v=>Math.round(v*10)/10), yAxisID:"yHours", type:"line",
        borderColor:"rgba(0,255,200,0.45)", borderWidth:2, backgroundColor:"rgba(0,255,200,0.06)",
        pointBackgroundColor:"rgba(0,255,200,0.55)", pointBorderColor:"rgba(13,15,28,1)", pointBorderWidth:2.5,
        pointRadius:3, pointHoverRadius:5, tension:0.4, fill:true, order:1 }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{ labels:{ color:"rgba(123,132,184,0.9)", font:{size:11,weight:'600'}, usePointStyle:true, pointStyle:'circle', boxWidth:8, boxHeight:8, padding:16 } },
        tooltip:{ backgroundColor:"rgba(7,8,15,0.96)", borderColor:"rgba(99,102,241,0.18)", borderWidth:1, titleColor:"rgba(232,234,248,0.95)", bodyColor:"rgba(123,132,184,0.9)", padding:13, cornerRadius:12, displayColors:true, boxWidth:8, boxHeight:8 }
      },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)", drawTicks:false}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", font:{size:11,weight:'600'}, padding:6} },
        yCount:{ position:"left", beginAtZero:true, grid:{color:"rgba(99,102,241,0.07)", drawTicks:false}, border:{display:false}, ticks:{precision:0, color:"rgba(123,132,184,0.65)", font:{size:10}, padding:8, maxTicksLimit:5} },
        yHours:{ position:"right", beginAtZero:true, grid:{drawOnChartArea:false, drawTicks:false}, border:{display:false}, ticks:{color:"rgba(0,255,200,0.35)", font:{size:10}, padding:8, maxTicksLimit:5} }
      }
    }
  });
}

async function fetchAllActivities(){
  const{data,error}=await sb.from("activities").select("id,start_time,sport,name,duration_s,distance_m,notes,source").order("start_time",{ascending:false}).limit(5000);
  if(error)throw error; return data||[];
}

function renderLatestList(list){
  const latest=list.slice(0,60);

  if(!latest.length){
    activitiesDiv.className="";
    activitiesDiv.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">üèãÔ∏è</div>
        <div class="empty-state-title">Inga pass √§nnu</div>
        <div class="empty-state-sub">L√§gg till ditt f√∂rsta pass via formul√§ret ovan.</div>
      </div>`;
    return;
  }

  activitiesDiv.className="activities-list";
  activitiesDiv.innerHTML="";

  for(const a of latest){
    const div=document.createElement("div");
    div.className="activity-item";

    const when=new Date(a.start_time);
    const wt=`${when.toLocaleDateString()} ${when.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`;

    const dist=formatDistance(a.distance_m);
    const dur=formatDuration(a.duration_s);
    const pace=calcPace(a.duration_s,a.distance_m);
    const isRun=(a.sport||"")==="L√∂pning";

    div.innerHTML=`
      <div class="activity-icon ${isRun?'run':'strength'}">
        ${isRun?'üèÉ':'üí™'}
      </div>

      <div class="activity-body">
        <div class="activity-name">${safeText(a.name||a.sport)}</div>
        <div class="activity-when">${wt} ¬∑ ${safeText(a.sport)}</div>

        <div class="activity-tags">
          ${dist?`<span class="tag">üìè ${dist}</span>`:''}
          ${dur?`<span class="tag">‚è± ${dur}</span>`:''}
          ${pace?`<span class="tag">‚ö° ${pace}</span>`:''}
          <span class="tag" style="opacity:.5">üóÇ ${safeText(a.source||"manual")}</span>
        </div>

        ${a.notes?`<div class="activity-notes">${safeText(a.notes)}</div>`:''}

        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn-ghost" type="button" onclick="editActivity('${a.id}')">‚úèÔ∏è Redigera</button>
          <button class="btn-ghost" type="button" style="border-color:var(--bad); color:var(--bad);" onclick="deleteActivity('${a.id}')">üóë Radera</button>
        </div>
      </div>

      <div class="activity-id">${safeText(a.id)}</div>
    `;

    activitiesDiv.appendChild(div);
  }
}

async function deleteActivity(id){
  if(!confirm("√Ñr du s√§ker p√• att du vill radera detta pass?")) return;

  try{
    if(!window.currentUser){ setMessage("Logga in.", true); return; }
    const { error } = await sb.from("activities").delete().eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;

    setMessage("Pass raderat ‚úì");
    applyEditLock();

/* ‚îÄ‚îÄ Golf ‚îÄ‚îÄ */
let chartGolfTrend=null;
let chartGolfDist=null;
let golfCache=[];

const gFilterHoles = document.getElementById("gFilterHoles");
const gStatHint = document.getElementById("gStatHint");

function setGolfMsg(t, err=false){
  const el=document.getElementById("gMsg"); if(!el) return;
  el.textContent=t||""; el.style.color = err ? "var(--bad)" : "var(--good)";
}

async function fetchGolf(){
  if(!window.currentUser) return [];
  const { data, error } = await sb.from("golf_rounds")
    .select("*")
    .eq("user_id", window.currentUser.id)
    .order("date", { ascending: false })
    .limit(60);
  if(error) throw error;
  return data || [];
}

function renderGolf(list){
  const root=document.getElementById("golfList");
  if(!root) return;
  if(!list.length){
    root.innerHTML = `
      <div class="empty-state" style="margin:0; padding:18px 14px;">
        <div class="empty-state-icon">‚õ≥</div>
        <div class="empty-state-title">Inga rundor √§nnu</div>
        <div class="empty-state-sub">L√§gg till din f√∂rsta runda till v√§nster.</div>
      </div>`;
    return;
  }
  root.innerHTML="";
  for(const r of list){
    const pills = [
      r.holes ? `<span class="pill">üï≥Ô∏è ${safeText(r.holes)} h√•l</span>` : "",
      (r.points!=null && r.points!=="") ? `<span class="pill soft">‚≠ê ${safeText(r.points)} p</span>` : "",
      (r.weather) ? `<span class="pill soft">‚òÅÔ∏è ${safeText(r.weather)}</span>` : ""
    ].join("");

    const counts = [
      (r.double_bogey!=null)?`DB ${r.double_bogey}`:"",
      (r.bogey!=null)?`B ${r.bogey}`:"",
      (r.par!=null)?`P ${r.par}`:"",
      (r.birdie!=null)?`Bi ${r.birdie}`:"",
      (r.eagle!=null)?`E ${r.eagle}`:""
    ].filter(Boolean).join(" ¬∑ ");

    const el=document.createElement("div");
    el.className="mini-item";
    el.innerHTML = `
      <div class="mini-main">
        <div class="mini-top">
          <div class="mini-name">${safeText(r.course || "Bana")} <span class="pill soft">üìÖ ${safeText(r.date || "")}</span></div>
          <div class="mini-time">${safeText(r.strokes)} slag</div>
        </div>
        <div class="mini-meta">${pills}${counts?`<span class="pill soft">üìä ${safeText(counts)}</span>`:""}</div>
        ${r.notes?`<div class="note-mini">${safeText(r.notes)}</div>`:""}
      </div>
      <div class="mini-actions">
        <button class="btn-ghost" type="button" onclick="editGolf('${r.id}')">‚úèÔ∏è</button>
        <button class="btn-ghost danger" type="button" onclick="deleteGolf('${r.id}')">üóë</button>
      </div>`;
    root.appendChild(el);
  }
}

function makeTrendData(list){
  const rows=[...list].sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  const labels=rows.map(r=>r.date);
  const strokes=rows.map(r=>r.strokes);
  const points=rows.map(r=> (r.points==null? null : r.points));
  return {labels, strokes, points};
}

function buildDistribution(list){
  const sum = { db:0, b:0, p:0, bi:0, e:0 };
  for(const r of list){
    sum.db += Number(r.double_bogey||0);
    sum.b  += Number(r.bogey||0);
    sum.p  += Number(r.par||0);
    sum.bi += Number(r.birdie||0);
    sum.e  += Number(r.eagle||0);
  }
  return sum;
}

function renderGolfCharts(list){
  const trendCanvas = document.getElementById("chartGolfTrend");
  const distCanvas  = document.getElementById("chartGolfDist");
  if(!trendCanvas || !distCanvas || !window.Chart) return;

  const {labels, strokes, points} = makeTrendData(list);
  const dist = buildDistribution(list);

  if(gStatHint){
    const n=list.length;
    const avgStrokes = n? (strokes.reduce((a,b)=>a+(b||0),0)/n).toFixed(1) : "‚Äî";
    const avgPoints  = n? (list.reduce((a,r)=>a+(r.points==null?0:r.points),0)/n).toFixed(1) : "‚Äî";
    gStatHint.innerHTML = n ? `Rundor: <b>${n}</b> ¬∑ Snitt slag: <b>${avgStrokes}</b> ¬∑ Snitt po√§ng: <b>${avgPoints}</b>` : "‚Äî";
  }

  if(chartGolfTrend) chartGolfTrend.destroy();
  chartGolfTrend = new Chart(trendCanvas,{
    type:"line",
    data:{
      labels: labels.length? labels : ["‚Äî"],
      datasets:[
        {
          label:"Slag",
          data: strokes.length? strokes : [null],
          borderColor:"rgba(255,159,64,0.92)",
          backgroundColor:"rgba(255,159,64,0.10)",
          pointBackgroundColor:"rgba(255,159,64,0.95)",
          pointBorderColor:"rgba(13,15,28,1)",
          pointBorderWidth:2,
          pointRadius:3,
          tension:0.35,
          fill:true
        },
        {
          label:"Po√§ng",
          data: points.length? points : [null],
          borderColor:"rgba(0,255,200,0.35)",
          backgroundColor:"rgba(0,255,200,0.05)",
          pointBackgroundColor:"rgba(0,255,200,0.45)",
          pointRadius:2,
          tension:0.35,
          fill:false
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{ labels:{ color:"rgba(123,132,184,0.9)", font:{size:11,weight:"600"}, usePointStyle:true, pointStyle:"circle", boxWidth:8, boxHeight:8, padding:16 } },
        tooltip:{ backgroundColor:"rgba(7,8,15,0.96)", borderColor:"rgba(99,102,241,0.18)", borderWidth:1, titleColor:"rgba(232,234,248,0.95)", bodyColor:"rgba(123,132,184,0.9)", padding:13, cornerRadius:12 }
      },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", maxTicksLimit:8} },
        y:{ beginAtZero:false, grid:{color:"rgba(99,102,241,0.07)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)"} }
      }
    }
  });

  if(chartGolfDist) chartGolfDist.destroy();
  chartGolfDist = new Chart(distCanvas,{
    type:"bar",
    data:{
      labels:["Dubbelbogey","Bogey","Par","Birdie","Eagle"],
      datasets:[{
        label:"Totalt (summa)",
        data:[dist.db, dist.b, dist.p, dist.bi, dist.e],
        backgroundColor:"rgba(167,139,250,0.55)",
        borderColor:"rgba(167,139,250,0.85)",
        borderWidth:1,
        borderRadius:8
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)"} },
        y:{ beginAtZero:true, grid:{color:"rgba(99,102,241,0.07)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", maxTicksLimit:5} }
      }
    }
  });
}

function applyGolfFilter(){
  const v = gFilterHoles ? gFilterHoles.value : "all";
  const list = v==="all" ? golfCache : golfCache.filter(r=>String(r.holes)===String(v));
  renderGolfCharts(list);
}

if(gFilterHoles){
  gFilterHoles.addEventListener("change", applyGolfFilter);
}

async function refreshGolf(){
  // Only refresh if elements exist (they do), and user exists
  try{
    const rows = await fetchGolf();
    golfCache = rows;
    renderGolf(rows);
    applyGolfFilter();
  }catch(e){
    const root=document.getElementById("golfList");
    if(root){
      root.innerHTML = `
        <div class="empty-state" style="margin:0; padding:18px 14px;">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div class="empty-state-title">Golf saknar tabell</div>
          <div class="empty-state-sub">${safeText(e?.message||"Skapa tabellen 'golf_rounds' i Supabase.")}</div>
        </div>`;
    }
  }
}

window.deleteGolf = async function(id){
  if(!confirm("Radera runda?")) return;
  try{
    const { error } = await sb.from("golf_rounds").delete().eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
    setGolfMsg("Runda raderad ‚úì");
    refreshGolf();
  }catch(e){ setGolfMsg(e?.message||"Kunde inte radera", true); }
}

window.editGolf = async function(id){
  try{
    const { data, error } = await sb.from("golf_rounds").select("*").eq("id", id).eq("user_id", window.currentUser.id).single();
    if(error) throw error;

    document.getElementById("gDate").value = data.date || "";
    document.getElementById("gCourse").value = data.course || "";
    document.getElementById("gHoles").value = String(data.holes || 18);
    document.getElementById("gStrokes").value = data.strokes ?? "";
    document.getElementById("gPoints").value = data.points ?? "";
    document.getElementById("gDoubleBogey").value = data.double_bogey ?? 0;
    document.getElementById("gBogey").value = data.bogey ?? 0;
    document.getElementById("gPar").value = data.par ?? 0;
    document.getElementById("gBirdie").value = data.birdie ?? 0;
    document.getElementById("gEagle").value = data.eagle ?? 0;
    document.getElementById("gWeather").value = data.weather || "";
    document.getElementById("gNotes").value = data.notes || "";

    const form=document.getElementById("golfForm");
    form.dataset.editId = data.id;
    document.getElementById("gSubmit").textContent = "Uppdatera runda";
    setGolfMsg("Redigerar runda‚Ä¶");
  }catch(e){ setGolfMsg(e?.message||"Kunde inte h√§mta", true); }
}

const golfForm = document.getElementById("golfForm");
if(golfForm){
  golfForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    setGolfMsg("");
    const payload = {
      user_id: window.currentUser.id,
      date: document.getElementById("gDate").value,
      course: document.getElementById("gCourse").value.trim(),
      holes: Number(document.getElementById("gHoles").value),
      strokes: Number(document.getElementById("gStrokes").value),
      points: document.getElementById("gPoints").value==="" ? null : Number(document.getElementById("gPoints").value),
      double_bogey: Number(document.getElementById("gDoubleBogey").value)||0,
      bogey: Number(document.getElementById("gBogey").value)||0,
      par: Number(document.getElementById("gPar").value)||0,
      birdie: Number(document.getElementById("gBirdie").value)||0,
      eagle: Number(document.getElementById("gEagle").value)||0,
      weather: document.getElementById("gWeather").value.trim() || null,
      notes: document.getElementById("gNotes").value.trim() || null
    };

    if(!payload.date || !payload.course || !isFinite(payload.strokes) || payload.strokes<=0){
      setGolfMsg("Fyll i datum, bana och antal slag.", true); return;
    }

    const editId=golfForm.dataset.editId || null;

    try{
      let error;
      if(editId){
        ({ error } = await sb.from("golf_rounds").update(payload).eq("id", editId).eq("user_id", window.currentUser.id));
      } else {
        ({ error } = await sb.from("golf_rounds").insert(payload));
      }
      if(error) throw error;

      golfForm.reset();
      delete golfForm.dataset.editId;
      document.getElementById("gDoubleBogey").value = 0;
      document.getElementById("gBogey").value = 0;
      document.getElementById("gPar").value = 0;
      document.getElementById("gBirdie").value = 0;
      document.getElementById("gEagle").value = 0;
      document.getElementById("gHoles").value = "18";
      document.getElementById("gSubmit").textContent = "Spara runda";

      setGolfMsg(editId ? "Runda uppdaterad ‚úì" : "Runda sparad ‚úì");
      refreshGolf();
    }catch(e){ setGolfMsg(e?.message||"Kunde inte spara", true); }
  });
}


refresh();
  }catch(e){
    setMessage(e?.message || "Kunde inte radera", true);
  }
}

async function editActivity(id){
  try{
    const { data, error } = await sb.from("activities")
      .select("*")
      .eq("id", id)
      .eq("user_id", window.currentUser.id)
      .single();

    if(error) throw error;

    // V√§xla till dashboard + visa formul√§r
    setActiveTab("dash");

    // Fyll formul√§ret
    hiddenStart.value = new Date(data.start_time).toISOString().slice(0,16);
    document.getElementById("sport").value = data.sport;
    document.getElementById("name").value = data.name || "";
    document.getElementById("notes").value = data.notes || "";

    if(data.duration_s){
      document.getElementById("duration_h").value = Math.floor(data.duration_s/3600);
      document.getElementById("duration_min").value = Math.floor((data.duration_s%3600)/60);
    } else {
      document.getElementById("duration_h").value = "";
      document.getElementById("duration_min").value = "";
    }

    if(data.distance_m){
      document.getElementById("distance_km").value = (data.distance_m/1000).toFixed(2);
    } else {
      document.getElementById("distance_km").value = "";
    }

    // √Ñndra knapp till "Uppdatera"
    form.dataset.editId = id;
    form.querySelector("button[type=submit]").textContent = "Uppdatera pass";

    // Uppdatera datumvisning
    const pad = n => String(n).padStart(2, "0");
    const dt = new Date(data.start_time);
    dateDisplayText.textContent = `${dt.toLocaleDateString("sv-SE")}  ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    dateDisplayText.classList.remove("placeholder");

  }catch(e){
    setMessage(e?.message || "Kunde inte h√§mta pass", true);
  }
}

function updateStatsForYear(b){
  const ts=b["L√∂pning"].counts.reduce((a,v)=>a+v,0)+b["Styrketr√§ning"].counts.reduce((a,v)=>a+v,0);
  const th=b["L√∂pning"].hours.reduce((a,v)=>a+v,0)+b["Styrketr√§ning"].hours.reduce((a,v)=>a+v,0);
  const rk=b["L√∂pning"].runKm.reduce((a,v)=>a+v,0);
  statTotalSessions.textContent=ts.toString();
  statTotalHours.innerHTML=`${Math.round(th*10)/10}<span class="stat-unit">h</span>`;
  statRunKm.innerHTML=`${Math.round(rk*10)/10}<span class="stat-unit">km</span>`;
}

const formRow = document.querySelector(".top-form-row");

function setActiveTab(which){
  const isDash = which==="dash";
  const isLogg = which==="logg";
  const isGolf = which==="golf";
  tabDash.classList.toggle("active", isDash);
  tabLogg.classList.toggle("active", isLogg);
  if(tabGolf) tabGolf.classList.toggle("active", isGolf);
  viewDash.classList.toggle("active", isDash);
  viewLogg.classList.toggle("active", isLogg);
  if(viewGolf) viewGolf.classList.toggle("active", isGolf);
  // Show activity form only on dashboard
  if(formRow) formRow.classList.toggle("hidden", !isDash);
  // Lazy-load golf when opening tab
  if(isGolf) refreshGolf();
}
tabDash.addEventListener("click",()=>setActiveTab("dash"));
tabLogg.addEventListener("click",()=>setActiveTab("logg"));
if(tabGolf) tabGolf.addEventListener("click",()=>setActiveTab("golf"));

async function refresh(){
  setMessage("");
  try{
    const all=await fetchAllActivities();
    ensureYearOptions(all); setSummary(all);
    const year=Number(yearSelect.value)||new Date().getFullYear();
    pillYear.textContent=`√Ör: ${year}`; subYear.textContent=`Valt √•r: ${year}`;
    const b=buildYearBuckets(all,year);
    updateStatsForYear(b);

    chartRun=makeChart("chartRun",b["L√∂pning"].runKm,b["L√∂pning"].hours,{
      bar:a=>`rgba(99,102,241,${a})`, line:"rgba(129,140,248,0.95)",
      area:(ctx)=>{ const g=ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height); g.addColorStop(0,"rgba(99,102,241,0.28)"); g.addColorStop(1,"rgba(99,102,241,0)"); return g; }
    },chartRun);

    chartStrength=makeHoursBarChart("chartStrength",b["Styrketr√§ning"].hours,{
      bar:a=>`rgba(59,130,246,${a})`
    },chartStrength);

    renderLatestList(all);
    // Also refresh golf cache (safe even if tab not open)
    try{ await refreshGolf(); }catch(_e){}
    await loadPRs();
    await loadRaces();
  } catch(e){
    activitiesDiv.className=""; activitiesDiv.innerHTML=`<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Kunde inte ladda data</div><div class="empty-state-sub">${e?.message||"Ok√§nt fel"}</div></div>`;
    setMessage(e?.message||"Ok√§nt fel",true);
  }
}

reloadBtn.addEventListener("click",refresh);
yearSelect.addEventListener("change",refresh);

form.addEventListener("submit",async(e)=>{
  if(!window.currentUser){ setMessage("Logga in.", true); return; }
  e.preventDefault();
  setMessage("");

  const editId = form.dataset.editId || null;

  const st = hiddenStart.value;
  if(!st){ setMessage("V√§lj datum & tid.", true); return; }

  const sport = document.getElementById("sport").value;
  const name  = document.getElementById("name").value.trim()  || null;
  const notes = document.getElementById("notes").value.trim() || null;

  const hRaw = document.getElementById("duration_h").value;
  const mRaw = document.getElementById("duration_min").value;

  const h = hRaw ? Math.max(0, Number(hRaw)) : 0;
  const m = mRaw ? Math.max(0, Number(mRaw)) : 0;

  if(mRaw && Number(mRaw) > 59){ setMessage("Minuter m√•ste vara 0‚Äì59.", true); return; }

  const duration_s = (h || m) ? (Math.floor(h)*3600 + Math.floor(m)*60) : null;

  const dkr = document.getElementById("distance_km").value;
  const distance_m = dkr ? (Number(dkr) * 1000) : null;

  const payload = {
    start_time: new Date(st).toISOString(),
    sport,
    name,
    duration_s,
    distance_m,
    notes
  };

  try{
    let error;

    if(editId){
      ({ error } = await sb.from("activities").update(payload).eq("id", editId).eq("user_id", window.currentUser.id));
    } else {
      payload.source = "manual";
      ({ error } = await sb.from("activities").insert(payload));
    }

    if(error) throw error;

    // Reset
    form.reset();
    hiddenStart.value = "";
    calSelected = null;

    delete form.dataset.editId;
    form.querySelector("button[type=submit]").textContent = "Spara pass";

    dateDisplayText.textContent = "V√§lj datum & tid‚Ä¶";
    dateDisplayText.classList.add("placeholder");

    setMessage(editId ? "Pass uppdaterat ‚úì" : "‚úì Sparat!");
    setActiveTab("logg");
    refresh();
  } catch(e2){
    setMessage(e2?.message || (editId ? "Kunde inte uppdatera" : "Kunde inte spara"), true);
  }
});


/* ‚îÄ‚îÄ Golf ‚îÄ‚îÄ */
let chartGolfTrend=null;
let chartGolfDist=null;
let golfCache=[];

const gFilterHoles = document.getElementById("gFilterHoles");
const gStatHint = document.getElementById("gStatHint");

function setGolfMsg(t, err=false){
  const el=document.getElementById("gMsg"); if(!el) return;
  el.textContent=t||""; el.style.color = err ? "var(--bad)" : "var(--good)";
}

async function fetchGolf(){
  if(!window.currentUser) return [];
  const { data, error } = await sb.from("golf_rounds")
    .select("*")
    .eq("user_id", window.currentUser.id)
    .order("date", { ascending: false })
    .limit(60);
  if(error) throw error;
  return data || [];
}

function renderGolf(list){
  const root=document.getElementById("golfList");
  if(!root) return;
  if(!list.length){
    root.innerHTML = `
      <div class="empty-state" style="margin:0; padding:18px 14px;">
        <div class="empty-state-icon">‚õ≥</div>
        <div class="empty-state-title">Inga rundor √§nnu</div>
        <div class="empty-state-sub">L√§gg till din f√∂rsta runda till v√§nster.</div>
      </div>`;
    return;
  }
  root.innerHTML="";
  for(const r of list){
    const pills = [
      r.holes ? `<span class="pill">üï≥Ô∏è ${safeText(r.holes)} h√•l</span>` : "",
      (r.points!=null && r.points!=="") ? `<span class="pill soft">‚≠ê ${safeText(r.points)} p</span>` : "",
      (r.weather) ? `<span class="pill soft">‚òÅÔ∏è ${safeText(r.weather)}</span>` : ""
    ].join("");

    const counts = [
      (r.double_bogey!=null)?`DB ${r.double_bogey}`:"",
      (r.bogey!=null)?`B ${r.bogey}`:"",
      (r.par!=null)?`P ${r.par}`:"",
      (r.birdie!=null)?`Bi ${r.birdie}`:"",
      (r.eagle!=null)?`E ${r.eagle}`:""
    ].filter(Boolean).join(" ¬∑ ");

    const el=document.createElement("div");
    el.className="mini-item";
    el.innerHTML = `
      <div class="mini-main">
        <div class="mini-top">
          <div class="mini-name">${safeText(r.course || "Bana")} <span class="pill soft">üìÖ ${safeText(r.date || "")}</span></div>
          <div class="mini-time">${safeText(r.strokes)} slag</div>
        </div>
        <div class="mini-meta">${pills}${counts?`<span class="pill soft">üìä ${safeText(counts)}</span>`:""}</div>
        ${r.notes?`<div class="note-mini">${safeText(r.notes)}</div>`:""}
      </div>
      <div class="mini-actions">
        <button class="btn-ghost" type="button" onclick="editGolf('${r.id}')">‚úèÔ∏è</button>
        <button class="btn-ghost danger" type="button" onclick="deleteGolf('${r.id}')">üóë</button>
      </div>`;
    root.appendChild(el);
  }
}

function makeTrendData(list){
  const rows=[...list].sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  const labels=rows.map(r=>r.date);
  const strokes=rows.map(r=>r.strokes);
  const points=rows.map(r=> (r.points==null? null : r.points));
  return {labels, strokes, points};
}

function buildDistribution(list){
  const sum = { db:0, b:0, p:0, bi:0, e:0 };
  for(const r of list){
    sum.db += Number(r.double_bogey||0);
    sum.b  += Number(r.bogey||0);
    sum.p  += Number(r.par||0);
    sum.bi += Number(r.birdie||0);
    sum.e  += Number(r.eagle||0);
  }
  return sum;
}

function renderGolfCharts(list){
  const trendCanvas = document.getElementById("chartGolfTrend");
  const distCanvas  = document.getElementById("chartGolfDist");
  if(!trendCanvas || !distCanvas || !window.Chart) return;

  const {labels, strokes, points} = makeTrendData(list);
  const dist = buildDistribution(list);

  if(gStatHint){
    const n=list.length;
    const avgStrokes = n? (strokes.reduce((a,b)=>a+(b||0),0)/n).toFixed(1) : "‚Äî";
    const avgPoints  = n? (list.reduce((a,r)=>a+(r.points==null?0:r.points),0)/n).toFixed(1) : "‚Äî";
    gStatHint.innerHTML = n ? `Rundor: <b>${n}</b> ¬∑ Snitt slag: <b>${avgStrokes}</b> ¬∑ Snitt po√§ng: <b>${avgPoints}</b>` : "‚Äî";
  }

  if(chartGolfTrend) chartGolfTrend.destroy();
  chartGolfTrend = new Chart(trendCanvas,{
    type:"line",
    data:{
      labels: labels.length? labels : ["‚Äî"],
      datasets:[
        {
          label:"Slag",
          data: strokes.length? strokes : [null],
          borderColor:"rgba(255,159,64,0.92)",
          backgroundColor:"rgba(255,159,64,0.10)",
          pointBackgroundColor:"rgba(255,159,64,0.95)",
          pointBorderColor:"rgba(13,15,28,1)",
          pointBorderWidth:2,
          pointRadius:3,
          tension:0.35,
          fill:true
        },
        {
          label:"Po√§ng",
          data: points.length? points : [null],
          borderColor:"rgba(0,255,200,0.35)",
          backgroundColor:"rgba(0,255,200,0.05)",
          pointBackgroundColor:"rgba(0,255,200,0.45)",
          pointRadius:2,
          tension:0.35,
          fill:false
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{ labels:{ color:"rgba(123,132,184,0.9)", font:{size:11,weight:"600"}, usePointStyle:true, pointStyle:"circle", boxWidth:8, boxHeight:8, padding:16 } },
        tooltip:{ backgroundColor:"rgba(7,8,15,0.96)", borderColor:"rgba(99,102,241,0.18)", borderWidth:1, titleColor:"rgba(232,234,248,0.95)", bodyColor:"rgba(123,132,184,0.9)", padding:13, cornerRadius:12 }
      },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", maxTicksLimit:8} },
        y:{ beginAtZero:false, grid:{color:"rgba(99,102,241,0.07)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)"} }
      }
    }
  });

  if(chartGolfDist) chartGolfDist.destroy();
  chartGolfDist = new Chart(distCanvas,{
    type:"bar",
    data:{
      labels:["Dubbelbogey","Bogey","Par","Birdie","Eagle"],
      datasets:[{
        label:"Totalt (summa)",
        data:[dist.db, dist.b, dist.p, dist.bi, dist.e],
        backgroundColor:"rgba(167,139,250,0.55)",
        borderColor:"rgba(167,139,250,0.85)",
        borderWidth:1,
        borderRadius:8
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ grid:{color:"rgba(99,102,241,0.06)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)"} },
        y:{ beginAtZero:true, grid:{color:"rgba(99,102,241,0.07)"}, border:{display:false}, ticks:{color:"rgba(123,132,184,0.65)", maxTicksLimit:5} }
      }
    }
  });
}

function applyGolfFilter(){
  const v = gFilterHoles ? gFilterHoles.value : "all";
  const list = v==="all" ? golfCache : golfCache.filter(r=>String(r.holes)===String(v));
  renderGolfCharts(list);
}

if(gFilterHoles){
  gFilterHoles.addEventListener("change", applyGolfFilter);
}

async function refreshGolf(){
  // Only refresh if elements exist (they do), and user exists
  try{
    const rows = await fetchGolf();
    golfCache = rows;
    renderGolf(rows);
    applyGolfFilter();
  }catch(e){
    const root=document.getElementById("golfList");
    if(root){
      root.innerHTML = `
        <div class="empty-state" style="margin:0; padding:18px 14px;">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div class="empty-state-title">Golf saknar tabell</div>
          <div class="empty-state-sub">${safeText(e?.message||"Skapa tabellen 'golf_rounds' i Supabase.")}</div>
        </div>`;
    }
  }
}

window.deleteGolf = async function(id){
  if(!confirm("Radera runda?")) return;
  try{
    const { error } = await sb.from("golf_rounds").delete().eq("id", id).eq("user_id", window.currentUser.id);
    if(error) throw error;
    setGolfMsg("Runda raderad ‚úì");
    refreshGolf();
  }catch(e){ setGolfMsg(e?.message||"Kunde inte radera", true); }
}

window.editGolf = async function(id){
  try{
    const { data, error } = await sb.from("golf_rounds").select("*").eq("id", id).eq("user_id", window.currentUser.id).single();
    if(error) throw error;

    document.getElementById("gDate").value = data.date || "";
    document.getElementById("gCourse").value = data.course || "";
    document.getElementById("gHoles").value = String(data.holes || 18);
    document.getElementById("gStrokes").value = data.strokes ?? "";
    document.getElementById("gPoints").value = data.points ?? "";
    document.getElementById("gDoubleBogey").value = data.double_bogey ?? 0;
    document.getElementById("gBogey").value = data.bogey ?? 0;
    document.getElementById("gPar").value = data.par ?? 0;
    document.getElementById("gBirdie").value = data.birdie ?? 0;
    document.getElementById("gEagle").value = data.eagle ?? 0;
    document.getElementById("gWeather").value = data.weather || "";
    document.getElementById("gNotes").value = data.notes || "";

    const form=document.getElementById("golfForm");
    form.dataset.editId = data.id;
    document.getElementById("gSubmit").textContent = "Uppdatera runda";
    setGolfMsg("Redigerar runda‚Ä¶");
  }catch(e){ setGolfMsg(e?.message||"Kunde inte h√§mta", true); }
}

const golfForm = document.getElementById("golfForm");
if(golfForm){
  golfForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    setGolfMsg("");
    const payload = {
      user_id: window.currentUser.id,
      date: document.getElementById("gDate").value,
      course: document.getElementById("gCourse").value.trim(),
      holes: Number(document.getElementById("gHoles").value),
      strokes: Number(document.getElementById("gStrokes").value),
      points: document.getElementById("gPoints").value==="" ? null : Number(document.getElementById("gPoints").value),
      double_bogey: Number(document.getElementById("gDoubleBogey").value)||0,
      bogey: Number(document.getElementById("gBogey").value)||0,
      par: Number(document.getElementById("gPar").value)||0,
      birdie: Number(document.getElementById("gBirdie").value)||0,
      eagle: Number(document.getElementById("gEagle").value)||0,
      weather: document.getElementById("gWeather").value.trim() || null,
      notes: document.getElementById("gNotes").value.trim() || null
    };

    if(!payload.date || !payload.course || !isFinite(payload.strokes) || payload.strokes<=0){
      setGolfMsg("Fyll i datum, bana och antal slag.", true); return;
    }

    const editId=golfForm.dataset.editId || null;

    try{
      let error;
      if(editId){
        ({ error } = await sb.from("golf_rounds").update(payload).eq("id", editId).eq("user_id", window.currentUser.id));
      } else {
        ({ error } = await sb.from("golf_rounds").insert(payload));
      }
      if(error) throw error;

      golfForm.reset();
      delete golfForm.dataset.editId;
      document.getElementById("gDoubleBogey").value = 0;
      document.getElementById("gBogey").value = 0;
      document.getElementById("gPar").value = 0;
      document.getElementById("gBirdie").value = 0;
      document.getElementById("gEagle").value = 0;
      document.getElementById("gHoles").value = "18";
      document.getElementById("gSubmit").textContent = "Spara runda";

      setGolfMsg(editId ? "Runda uppdaterad ‚úì" : "Runda sparad ‚úì");
      refreshGolf();
    }catch(e){ setGolfMsg(e?.message||"Kunde inte spara", true); }
  });
}


refresh();
</script>
</body>
</html>
